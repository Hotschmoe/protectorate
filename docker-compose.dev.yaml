# docker-compose.dev.yaml
# Development configuration with volume-mounted binaries and hot-reload webui
#
# NOTE: This is for LOCAL DEVELOPMENT only.
#       Production uses docker-compose.yaml with pre-built ghcr.io images.
#
# Usage:
#   make dev        # Start dev environment
#   make dev-logs   # View logs
#   make dev-down   # Stop dev environment
#
# Webui changes: Just refresh browser (no rebuild needed!)
# Go changes:    make dev-restart

services:
  envoy:
    image: protectorate/base:latest
    container_name: envoy-dev
    ports:
      - "7470:7470"
      - "7681:7681"
    volumes:
      # Mount pre-built binary (rebuild with: make bin/envoy)
      - ./bin/envoy:/usr/local/bin/envoy:ro

      # Mount entrypoint (single source of truth)
      - ./containers/envoy/entrypoint.sh:/entrypoint.sh:ro

      # Mount webui for hot-reload (just refresh browser!)
      - ./internal/envoy/web:/app/web:ro

      # Docker socket for sleeve management
      - /var/run/docker.sock:/var/run/docker.sock

      # Claude credentials and settings
      - ${HOME}/.claude/.credentials.json:/home/claude/.claude/.credentials.json:ro
      - ${HOME}/.claude.json:/etc/claude/settings.json:ro
      - ${HOME}/.claude/plugins:/home/claude/.claude/plugins:ro

      # Git config from host (for commit identity)
      - ${HOME}/.gitconfig:/root/.gitconfig:ro

      # SSH agent from host (for git push - repos must use SSH URLs)
      # Requires: eval $(ssh-agent) && ssh-add (on host)
      - ${SSH_AUTH_SOCK}:/ssh-agent:ro

      # Workspaces (all sleeve directories visible here)
      - ./workspaces:/home/claude/workspaces

    environment:
      - DEV_MODE=true
      - SLEEVE_IMAGE=protectorate/sleeve:latest
      - WORKSPACE_HOST_ROOT=${PWD}/workspaces
      - CREDENTIALS_HOST_PATH=${HOME}/.claude/.credentials.json
      - SETTINGS_HOST_PATH=${HOME}/.claude.json
      - PLUGINS_HOST_PATH=${HOME}/.claude/plugins
      # Git settings
      - GIT_CLONE_PROTOCOL=${GIT_CLONE_PROTOCOL:-ssh}
      - GIT_COMMITTER_NAME=${GIT_COMMITTER_NAME:-}
      - GIT_COMMITTER_EMAIL=${GIT_COMMITTER_EMAIL:-}
      - SSH_AUTH_SOCK=/ssh-agent
    networks:
      - raven
    user: root
    entrypoint: ["/bin/bash", "/entrypoint.sh"]
    restart: unless-stopped

networks:
  raven:
    name: raven
