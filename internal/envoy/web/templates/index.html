<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protectorate // Envoy</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Orbitron:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css">
    <style>
        :root {
            /* Background Layers */
            --bg-deep: #0a0a0f;
            --bg-surface: #12121a;
            --bg-elevated: #1a1a24;
            --bg-overlay: rgba(10, 10, 15, 0.8);

            /* Cyan family - "stack active" */
            --cyan-glow: #00f5ff;
            --cyan-dim: #00a5aa;
            --cyan-subtle: #004d4f;

            /* Amber family - "attention" */
            --amber-glow: #ffaa00;
            --amber-dim: #aa7700;

            /* Magenta family - "critical/error" */
            --magenta-glow: #ff0055;
            --magenta-dim: #aa0038;

            /* Text */
            --text-primary: #e0e0e0;
            --text-secondary: #808090;
            --text-muted: #505060;

            /* Typography */
            --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
            --font-display: 'Orbitron', 'Rajdhani', sans-serif;

            /* Sizes */
            --text-xs: 0.75rem;
            --text-sm: 0.875rem;
            --text-base: 1rem;
            --text-lg: 1.25rem;
            --text-xl: 1.5rem;
            --text-2xl: 2rem;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: var(--bg-deep);
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: var(--text-base);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Scanlines overlay */
        .scanlines {
            position: fixed;
            inset: 0;
            pointer-events: none;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 0, 0, 0.03) 2px,
                rgba(0, 0, 0, 0.03) 4px
            );
            z-index: 1000;
        }

        /* Top Navigation */
        .top-nav {
            background: var(--bg-surface);
            border-bottom: 1px solid var(--cyan-subtle);
            padding: 0 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }

        .brand {
            font-family: var(--font-display);
            font-size: var(--text-lg);
            font-weight: 700;
            color: var(--cyan-glow);
            text-shadow: 0 0 10px var(--cyan-subtle);
        }

        .brand span {
            color: var(--text-secondary);
            font-weight: 400;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .cluster-badge {
            background: var(--bg-elevated);
            border: 1px solid var(--cyan-subtle);
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: var(--text-sm);
            color: var(--text-secondary);
        }

        .admin-badge {
            background: var(--cyan-subtle);
            color: var(--cyan-glow);
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: var(--text-sm);
            font-weight: 600;
        }

        .admin-badge.authenticated {
            background: rgba(0, 245, 255, 0.2);
        }

        .admin-badge.unauthenticated {
            background: rgba(255, 0, 85, 0.2);
            color: var(--magenta-glow);
        }

        /* Tab Navigation */
        .tab-nav {
            background: var(--bg-surface);
            border-bottom: 1px solid var(--cyan-subtle);
            display: flex;
            padding: 0 1.5rem;
        }

        .tab {
            padding: 1rem 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            font-size: var(--text-sm);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .tab:hover {
            color: var(--text-primary);
            background: var(--bg-elevated);
        }

        .tab.active {
            color: var(--cyan-glow);
            border-bottom-color: var(--cyan-glow);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Main Content */
        .main-content {
            padding: 1.5rem;
            max-width: 1600px;
            margin: 0 auto;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .dashboard-title {
            font-family: var(--font-display);
            font-size: var(--text-xl);
            color: var(--text-primary);
        }

        .dashboard-stats {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: var(--text-2xl);
            font-weight: 700;
            color: var(--cyan-glow);
        }

        .stat-value.warning { color: var(--amber-glow); }
        .stat-value.critical { color: var(--magenta-glow); }

        .stat-label {
            font-size: var(--text-xs);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--cyan-subtle);
            background: transparent;
            color: var(--text-secondary);
            font-family: var(--font-mono);
            font-size: var(--text-sm);
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 4px;
        }

        .btn:hover {
            background: var(--cyan-subtle);
            color: var(--cyan-glow);
            border-color: var(--cyan-dim);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--cyan-subtle);
            color: var(--cyan-glow);
            border-color: var(--cyan-dim);
        }

        .btn-primary:hover {
            background: var(--cyan-dim);
            box-shadow: 0 0 10px var(--cyan-subtle);
        }

        .btn-danger {
            border-color: var(--magenta-dim);
            color: var(--magenta-glow);
        }

        .btn-danger:hover {
            background: var(--magenta-dim);
            border-color: var(--magenta-glow);
        }

        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: var(--text-xs);
        }

        /* Sleeve Grid */
        .sleeve-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 1.5rem;
        }

        /* Sleeve Card */
        .sleeve-card {
            background: linear-gradient(135deg, var(--bg-surface) 0%, var(--bg-elevated) 100%);
            border: 1px solid var(--cyan-subtle);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .sleeve-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--cyan-glow);
        }

        .sleeve-card.healthy {
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.1);
        }

        .sleeve-card.healthy::before {
            background: var(--cyan-glow);
            box-shadow: 0 0 10px var(--cyan-glow);
        }

        .sleeve-card.warning::before {
            background: var(--amber-glow);
            box-shadow: 0 0 10px var(--amber-glow);
        }

        .sleeve-card.critical {
            animation: pulse-critical 2s ease-in-out infinite;
        }

        .sleeve-card.critical::before {
            background: var(--magenta-glow);
            box-shadow: 0 0 10px var(--magenta-glow);
        }

        @keyframes pulse-critical {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 0, 85, 0.2); }
            50% { box-shadow: 0 0 30px rgba(255, 0, 85, 0.4); }
        }

        .sleeve-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--cyan-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sleeve-name {
            font-family: var(--font-display);
            font-size: var(--text-lg);
            font-weight: 600;
            color: var(--cyan-glow);
        }

        .sleeve-status {
            font-size: var(--text-xs);
            text-transform: uppercase;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
        }

        .sleeve-status.active {
            background: rgba(0, 245, 255, 0.2);
            color: var(--cyan-glow);
        }

        .sleeve-status.idle {
            background: rgba(128, 128, 144, 0.2);
            color: var(--text-secondary);
        }

        .sleeve-body {
            padding: 1.25rem;
        }

        .sleeve-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .sleeve-label {
            color: var(--text-muted);
            font-size: var(--text-sm);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .sleeve-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .sleeve-actions {
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--cyan-subtle);
            display: flex;
            gap: 0.75rem;
        }

        .sleeve-actions .btn {
            flex: 1;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-secondary);
            border: 1px dashed var(--cyan-subtle);
            border-radius: 8px;
            background: var(--bg-surface);
        }

        /* Panel (for workspaces, doctor, etc) */
        .panel {
            background: var(--bg-surface);
            border: 1px solid var(--cyan-subtle);
            border-radius: 8px;
        }

        .panel-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--cyan-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-family: var(--font-display);
            font-size: var(--text-lg);
            font-weight: 600;
            color: var(--text-primary);
        }

        .panel-body { padding: 1.25rem; }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            text-align: left;
            padding: 0.75rem;
            border-bottom: 1px solid var(--cyan-subtle);
        }

        th {
            color: var(--text-muted);
            font-weight: 500;
            text-transform: uppercase;
            font-size: var(--text-xs);
            letter-spacing: 0.05em;
        }

        td { color: var(--text-primary); }

        /* Git status colors */
        .git-branch { color: var(--cyan-glow); font-family: var(--font-mono); }
        .git-detached { color: var(--amber-glow); font-family: var(--font-mono); }
        .git-no-repo { color: var(--text-muted); }
        .git-clean { color: var(--cyan-glow); }
        .git-dirty { color: var(--magenta-glow); }
        .git-ahead { color: var(--cyan-dim); }
        .git-behind { color: var(--amber-glow); }
        .git-commit-hash { color: var(--text-secondary); font-family: var(--font-mono); }
        .git-commit-time { color: var(--text-muted); font-size: 0.85em; }

        .action-buttons {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
        }

        .fetch-indicator {
            color: var(--text-muted);
            font-size: var(--text-sm);
            margin-right: 1rem;
            animation: blink 1s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .inline-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid var(--cyan-subtle);
            border-top-color: var(--cyan-glow);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-right: 6px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Doctor checks */
        .doctor-checks {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .doctor-check {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-elevated);
            border: 1px solid var(--cyan-subtle);
            border-radius: 6px;
        }

        .doctor-check-icon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .doctor-check-icon.pass { color: var(--cyan-glow); }
        .doctor-check-icon.warning { color: var(--amber-glow); }
        .doctor-check-icon.fail { color: var(--magenta-glow); }

        .doctor-check-content { flex: 1; }

        .doctor-check-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .doctor-check-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .doctor-check-status {
            font-size: var(--text-xs);
            font-weight: 600;
            text-transform: uppercase;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
        }

        .doctor-check-status.pass {
            background: rgba(0, 245, 255, 0.2);
            color: var(--cyan-glow);
        }

        .doctor-check-status.warning {
            background: rgba(255, 170, 0, 0.2);
            color: var(--amber-glow);
        }

        .doctor-check-status.fail {
            background: rgba(255, 0, 85, 0.2);
            color: var(--magenta-glow);
        }

        .doctor-check-message {
            color: var(--text-secondary);
            font-size: var(--text-sm);
        }

        .doctor-check-suggestion {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-deep);
            border-left: 3px solid var(--cyan-dim);
            color: var(--text-secondary);
            font-size: var(--text-sm);
        }

        .doctor-check-suggestion code {
            background: var(--bg-elevated);
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            font-family: var(--font-mono);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-overlay);
            justify-content: center;
            align-items: center;
            z-index: 999;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: var(--bg-surface);
            border: 1px solid var(--cyan-subtle);
            border-radius: 8px;
            padding: 2rem;
            width: 400px;
            position: relative;
            box-shadow: 0 0 30px rgba(0, 245, 255, 0.1);
        }

        .modal-title {
            font-family: var(--font-display);
            font-size: var(--text-lg);
            color: var(--cyan-glow);
            margin-bottom: 1rem;
        }

        .form-group { margin-bottom: 1rem; }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: var(--text-sm);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-input {
            width: 100%;
            padding: 0.5rem;
            background: var(--bg-deep);
            border: 1px solid var(--cyan-subtle);
            border-radius: 4px;
            color: var(--text-primary);
            font-family: var(--font-mono);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--cyan-dim);
            box-shadow: 0 0 5px var(--cyan-subtle);
        }

        .form-select {
            width: 100%;
            padding: 0.5rem;
            background: var(--bg-deep);
            border: 1px solid var(--cyan-subtle);
            border-radius: 4px;
            color: var(--text-primary);
            font-family: var(--font-mono);
        }

        .form-select option { background: var(--bg-deep); }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }

        .radio-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .radio-option input { cursor: pointer; }

        .hidden { display: none; }

        .error-text {
            color: var(--magenta-glow);
            font-size: var(--text-sm);
            margin-top: 0.5rem;
        }

        /* Spawn loading overlay */
        .spawn-loading {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(18, 18, 26, 0.95);
            border-radius: 8px;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 1rem;
        }

        .spawn-loading.active { display: flex; }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--cyan-subtle);
            border-top-color: var(--cyan-glow);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .spawn-loading-text {
            color: var(--text-secondary);
            font-size: var(--text-sm);
        }

        /* Terminal modal */
        .terminal-modal {
            width: 80%;
            height: 70%;
            padding: 0;
        }

        .terminal-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--cyan-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-surface);
        }

        .terminal-container {
            height: calc(100% - 50px);
            padding: 0.5rem;
            background: var(--bg-deep);
            border-radius: 0 0 8px 8px;
        }

        .terminal-container .xterm { padding: 8px; }

        .terminal-container .xterm-viewport {
            scrollbar-width: thin;
            scrollbar-color: var(--cyan-subtle) var(--bg-deep);
        }

        .terminal-container .xterm-viewport::-webkit-scrollbar { width: 8px; }
        .terminal-container .xterm-viewport::-webkit-scrollbar-track { background: var(--bg-deep); }
        .terminal-container .xterm-viewport::-webkit-scrollbar-thumb {
            background: var(--cyan-subtle);
            border-radius: 4px;
        }
        .terminal-container .xterm-viewport::-webkit-scrollbar-thumb:hover {
            background: var(--cyan-dim);
        }

        .terminal-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 8px;
            vertical-align: middle;
            background: var(--text-muted);
        }

        .terminal-status.connected { background: var(--cyan-glow); }
        .terminal-status.connecting { background: var(--amber-glow); animation: blink 1s infinite; }
        .terminal-status.disconnected { background: var(--magenta-glow); }
        .terminal-status.error { background: var(--magenta-glow); }

        .reconnect-info {
            font-size: var(--text-xs);
            color: var(--text-muted);
            margin-left: 0.5rem;
        }

        .terminal-readonly-badge {
            display: none;
            background: rgba(255, 170, 0, 0.2);
            color: var(--amber-glow);
            font-size: var(--text-xs);
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            margin-left: 0.5rem;
            text-transform: uppercase;
            font-weight: 600;
        }

        .terminal-readonly-badge.active { display: inline-block; }

        /* Placeholder content for new tabs */
        .placeholder-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            text-align: center;
            color: var(--text-muted);
        }

        .placeholder-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .placeholder-title {
            font-family: var(--font-display);
            font-size: var(--text-xl);
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .placeholder-desc {
            font-size: var(--text-sm);
            max-width: 400px;
        }

        /* Needlecast 3-column layout (placeholder structure) */
        .needlecast-layout {
            display: grid;
            grid-template-columns: 200px 1fr 250px;
            gap: 1rem;
            min-height: 500px;
        }

        .needlecast-sidebar {
            background: var(--bg-surface);
            border: 1px solid var(--cyan-subtle);
            border-radius: 8px;
            padding: 1rem;
        }

        .needlecast-sidebar-title {
            font-size: var(--text-xs);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
        }

        .needlecast-sleeve-item {
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .needlecast-sleeve-item:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .needlecast-sleeve-item.active {
            background: var(--cyan-subtle);
            color: var(--cyan-glow);
        }

        .needlecast-main {
            background: var(--bg-surface);
            border: 1px solid var(--cyan-subtle);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
        }

        .needlecast-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .needlecast-input {
            border-top: 1px solid var(--cyan-subtle);
            padding: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .needlecast-input input {
            flex: 1;
            padding: 0.5rem;
            background: var(--bg-deep);
            border: 1px solid var(--cyan-subtle);
            border-radius: 4px;
            color: var(--text-primary);
            font-family: var(--font-mono);
        }

        .needlecast-thread {
            background: var(--bg-surface);
            border: 1px solid var(--cyan-subtle);
            border-radius: 8px;
            padding: 1rem;
        }

        .needlecast-thread-title {
            font-size: var(--text-xs);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="scanlines"></div>

    <nav class="top-nav">
        <div class="brand">PROTECTORATE <span>//ENVOY</span></div>
        <div class="nav-right">
            <button class="btn" onclick="openEnvoyTerminal()">Terminal</button>
            <span class="cluster-badge">cluster: local</span>
            <span id="auth-badge" class="admin-badge unauthenticated">AUTH</span>
        </div>
    </nav>

    <nav class="tab-nav">
        <div class="tab active" onclick="switchTab('sleeves')">Sleeves</div>
        <div class="tab" onclick="switchTab('needlecast')">Needlecast</div>
        <div class="tab" onclick="switchTab('logs')">Logs</div>
        <div class="tab" onclick="switchTab('config')">Config</div>
        <div class="tab" onclick="switchTab('workspaces')">Workspaces</div>
        <div class="tab" onclick="switchTab('doctor')">Doctor</div>
    </nav>

    <!-- SLEEVES TAB -->
    <div id="tab-sleeves" class="tab-content active">
        <main class="main-content">
            <div class="dashboard-header">
                <h1 class="dashboard-title">SLEEVE REGISTRY</h1>
                <div class="dashboard-stats">
                    <div class="stat">
                        <div id="stat-active" class="stat-value">0</div>
                        <div class="stat-label">Active</div>
                    </div>
                    <button class="btn btn-primary" onclick="showSpawnModal()">+ SPAWN SLEEVE</button>
                </div>
            </div>
            <div id="sleeves-grid" class="sleeve-grid">
                <div class="empty-state">No sleeves running. Click "+ SPAWN SLEEVE" to create one.</div>
            </div>
        </main>
    </div>

    <!-- NEEDLECAST TAB -->
    <div id="tab-needlecast" class="tab-content">
        <main class="main-content">
            <div class="dashboard-header">
                <h1 class="dashboard-title">NEEDLECAST</h1>
            </div>
            <div class="needlecast-layout">
                <div class="needlecast-sidebar">
                    <div class="needlecast-sidebar-title">Sleeves</div>
                    <div class="needlecast-sleeve-item active">GLOBAL</div>
                    <div id="needlecast-sleeve-list"></div>
                </div>
                <div class="needlecast-main">
                    <div class="needlecast-messages">
                        <div class="placeholder-content">
                            <div class="placeholder-title">Inter-Sleeve Messaging</div>
                            <div class="placeholder-desc">Select a sleeve to view messages. Needlecast enables real-time communication between sleeves via filesystem-based messaging.</div>
                        </div>
                    </div>
                    <div class="needlecast-input">
                        <input type="text" placeholder="Message content..." disabled>
                        <button class="btn" disabled>Send</button>
                    </div>
                </div>
                <div class="needlecast-thread">
                    <div class="needlecast-thread-title">Thread Visualization</div>
                    <div class="placeholder-content" style="min-height: 200px;">
                        <div class="placeholder-desc">Message flow visualization coming soon</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- LOGS TAB -->
    <div id="tab-logs" class="tab-content">
        <main class="main-content">
            <div class="dashboard-header">
                <h1 class="dashboard-title">LOGS</h1>
            </div>
            <div class="panel">
                <div class="panel-body">
                    <div class="placeholder-content">
                        <div class="placeholder-title">System Logs</div>
                        <div class="placeholder-desc">Aggregated logs from Envoy and all active sleeves. Coming soon.</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- CONFIG TAB -->
    <div id="tab-config" class="tab-content">
        <main class="main-content">
            <div class="dashboard-header">
                <h1 class="dashboard-title">CONFIGURATION</h1>
            </div>
            <div class="panel">
                <div class="panel-body">
                    <div class="placeholder-content">
                        <div class="placeholder-title">System Configuration</div>
                        <div class="placeholder-desc">Envoy and sleeve configuration management. Coming soon.</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- WORKSPACES TAB -->
    <div id="tab-workspaces" class="tab-content">
        <main class="main-content">
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">WORKSPACES</span>
                    <div style="display: flex; align-items: center;">
                        <span id="fetch-indicator" class="fetch-indicator" style="display: none;">fetching...</span>
                        <button class="btn btn-primary" onclick="showCloneModal()">+ Clone from Git</button>
                    </div>
                </div>
                <div class="panel-body">
                    <table id="workspaces-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Branch</th>
                                <th>Git Status</th>
                                <th>Cstack</th>
                                <th>Last Commit</th>
                                <th>Sleeve</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <div id="workspaces-empty" class="empty-state hidden">
                        No workspaces yet. Click "+ Clone from Git" to clone a repository.
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- DOCTOR TAB -->
    <div id="tab-doctor" class="tab-content">
        <main class="main-content">
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">SYSTEM HEALTH CHECKS</span>
                    <button class="btn" onclick="refreshDoctor()">Refresh</button>
                </div>
                <div class="panel-body">
                    <div id="doctor-checks" class="doctor-checks">
                        <div class="empty-state">Loading checks...</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- SPAWN MODAL -->
    <div id="spawn-modal" class="modal">
        <div class="modal-content">
            <div id="spawn-loading" class="spawn-loading">
                <div class="spinner"></div>
                <div class="spawn-loading-text">Spawning sleeve...</div>
            </div>
            <h2 class="modal-title">SPAWN NEW SLEEVE</h2>
            <form id="spawn-form" onsubmit="spawnSleeve(event)">
                <div class="form-group">
                    <label class="form-label">Workspace</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="ws-mode" value="existing" checked onchange="toggleWorkspaceMode()">
                            Use existing
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="ws-mode" value="new" onchange="toggleWorkspaceMode()">
                            Create new
                        </label>
                    </div>
                </div>
                <div class="form-group" id="existing-ws-group">
                    <label class="form-label">Select Workspace</label>
                    <select class="form-select" id="existing-workspace-select" required>
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="form-group hidden" id="new-ws-group">
                    <label class="form-label">Workspace Name</label>
                    <input type="text" class="form-input" id="new-workspace-input"
                           placeholder="my-project" pattern="[a-zA-Z0-9_-]+"
                           title="Letters, numbers, dashes, underscores only">
                </div>
                <div class="form-group">
                    <label class="form-label">Sleeve Name (optional)</label>
                    <input type="text" class="form-input" id="name-input"
                           placeholder="Auto-assigned from pool">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="hideSpawnModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Spawn</button>
                </div>
            </form>
        </div>
    </div>

    <!-- CLONE MODAL -->
    <div id="clone-modal" class="modal">
        <div class="modal-content">
            <div id="clone-loading" class="spawn-loading">
                <div class="spinner"></div>
                <div class="clone-loading-text">Cloning repository...</div>
            </div>
            <h2 class="modal-title">CLONE REPOSITORY</h2>
            <form id="clone-form" onsubmit="cloneWorkspace(event)">
                <div class="form-group">
                    <label class="form-label">Repository URL</label>
                    <input type="url" class="form-input" id="clone-url-input"
                           placeholder="https://github.com/owner/repo"
                           pattern="https://.*"
                           title="HTTPS URLs only"
                           required>
                </div>
                <div class="form-group">
                    <label class="form-label">Workspace Name (optional)</label>
                    <input type="text" class="form-input" id="clone-name-input"
                           placeholder="Auto-derived from repo URL"
                           pattern="[a-zA-Z0-9_-]*"
                           title="Letters, numbers, dashes, underscores only">
                </div>
                <div id="clone-error" class="error-text hidden"></div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="hideCloneModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="clone-submit-btn">Clone</button>
                </div>
            </form>
        </div>
    </div>

    <!-- SWITCH BRANCH MODAL -->
    <div id="switch-branch-modal" class="modal">
        <div class="modal-content">
            <div id="switch-loading" class="spawn-loading">
                <div class="spinner"></div>
                <div class="switch-loading-text">Switching branch...</div>
            </div>
            <h2 class="modal-title">SWITCH BRANCH</h2>
            <p style="margin-bottom: 1rem; color: var(--text-secondary);">Workspace: <strong id="switch-ws-name" style="color: var(--cyan-glow);"></strong></p>
            <form id="switch-form" onsubmit="switchBranch(event)">
                <div class="form-group">
                    <label class="form-label">Select Branch</label>
                    <select class="form-select" id="branch-select" required>
                        <option value="">Loading branches...</option>
                    </select>
                </div>
                <div id="switch-error" class="error-text hidden"></div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="hideSwitchModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="switch-submit-btn">Switch</button>
                </div>
            </form>
            <input type="hidden" id="switch-ws-path">
        </div>
    </div>

    <!-- CSTACK INIT MODAL -->
    <div id="cstack-init-modal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">INITIALIZE CSTACK</h2>
            <p style="color: var(--text-secondary);">Workspace: <strong id="cstack-init-ws-name" style="color: var(--cyan-glow);"></strong></p>

            <form id="cstack-init-form" onsubmit="initCstack(event)">
                <div class="form-group">
                    <label class="form-label">Choose initialization mode:</label>

                    <div style="margin:0.75rem 0;padding:0.75rem;background:var(--bg-deep);border:1px solid var(--cyan-subtle);border-radius:6px">
                        <label style="display:flex;align-items:start;cursor:pointer">
                            <input type="radio" name="cstack-mode" value="minimal" checked style="margin-top:4px">
                            <div style="margin-left:0.5rem">
                                <strong style="color:var(--text-primary)">Minimal</strong>
                                <div style="color:var(--text-secondary);font-size:var(--text-sm)">Create empty .cstack/ directory</div>
                            </div>
                        </label>
                    </div>

                    <div style="margin:0.75rem 0;padding:0.75rem;background:var(--bg-deep);border:1px solid var(--cyan-subtle);border-radius:6px">
                        <label style="display:flex;align-items:start;cursor:pointer">
                            <input type="radio" name="cstack-mode" value="interview" style="margin-top:4px">
                            <div style="margin-left:0.5rem">
                                <strong style="color:var(--text-primary)">Interview (Recommended)</strong>
                                <div style="color:var(--text-secondary);font-size:var(--text-sm)">Init + mark for Claude interview on sleeve spawn</div>
                            </div>
                        </label>
                    </div>
                </div>

                <div id="cstack-init-error" class="error-text hidden"></div>

                <div class="form-actions">
                    <button type="button" class="btn" onclick="hideCstackInitModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="cstack-init-btn">Initialize</button>
                </div>
            </form>
            <input type="hidden" id="cstack-init-ws-path">
        </div>
    </div>

    <!-- TERMINAL MODAL -->
    <div id="terminal-modal" class="modal">
        <div class="modal-content terminal-modal">
            <div class="terminal-header">
                <div style="display: flex; align-items: center;">
                    <span id="terminal-title" style="color: var(--cyan-glow);">Terminal</span>
                    <span id="terminal-readonly-badge" class="terminal-readonly-badge">Read-Only</span>
                    <span id="terminal-status" class="terminal-status"></span>
                    <span id="reconnect-info" class="reconnect-info"></span>
                </div>
                <button class="btn" onclick="hideTerminalModal()">Close</button>
            </div>
            <div id="terminal-container" class="terminal-container"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.min.js"></script>
    <script>
        let currentConnection = null;
        let currentCloneJobId = null;
        let clonePollingInterval = null;
        let lastFetchAllTime = 0;
        const FETCH_ALL_THROTTLE_MS = 60000;

        const MSG_DATA = 0x30;
        const MSG_RESIZE = 0x31;

        function buildTerminalMessage(type, data) {
            const msg = new Uint8Array(data.length + 1);
            msg[0] = type;
            for (let i = 0; i < data.length; i++) {
                msg[i + 1] = data.charCodeAt(i);
            }
            return msg.buffer;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            const tabs = ['sleeves', 'needlecast', 'logs', 'config', 'workspaces', 'doctor'];
            const tabIndex = tabs.indexOf(tabName);
            if (tabIndex >= 0) {
                document.querySelectorAll('.tab')[tabIndex].classList.add('active');
                document.getElementById(`tab-${tabName}`).classList.add('active');
            }

            if (tabName === 'workspaces') {
                refreshWorkspacesTable();
                triggerFetchAllThrottled();
            } else if (tabName === 'doctor') {
                refreshDoctor();
            } else if (tabName === 'needlecast') {
                updateNeedlecastSleeveList();
            }
        }

        async function refreshDoctor() {
            const container = document.getElementById('doctor-checks');
            container.innerHTML = '<div class="empty-state"><span class="inline-spinner"></span> Running checks...</div>';

            try {
                const resp = await fetch('/api/doctor');
                const checks = await resp.json();

                if (checks.length === 0) {
                    container.innerHTML = '<div class="empty-state">No checks available</div>';
                    return;
                }

                container.innerHTML = checks.map(check => {
                    const icon = check.status === 'pass' ? '[*]' : check.status === 'warning' ? '[!]' : '[x]';
                    const suggestion = check.suggestion
                        ? `<div class="doctor-check-suggestion">${escapeHtml(check.suggestion)}</div>`
                        : '';
                    return `
                        <div class="doctor-check">
                            <div class="doctor-check-icon ${check.status}">${icon}</div>
                            <div class="doctor-check-content">
                                <div class="doctor-check-header">
                                    <span class="doctor-check-name">${escapeHtml(check.name)}</span>
                                    <span class="doctor-check-status ${check.status}">${check.status}</span>
                                </div>
                                <div class="doctor-check-message">${escapeHtml(check.message)}</div>
                                ${suggestion}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('Failed to fetch doctor checks:', e);
                container.innerHTML = '<div class="empty-state">Failed to load checks</div>';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function triggerFetchAllThrottled() {
            const now = Date.now();
            if (now - lastFetchAllTime < FETCH_ALL_THROTTLE_MS) {
                return;
            }
            lastFetchAllTime = now;

            const indicator = document.getElementById('fetch-indicator');
            indicator.style.display = 'inline';
            const startTime = Date.now();
            const minDisplayMs = 1500;

            try {
                await fetch('/api/workspaces/branches?action=fetch-all', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                refreshWorkspacesTable();
            } catch (e) {
                console.error('Fetch all failed:', e);
            } finally {
                const elapsed = Date.now() - startTime;
                const remaining = minDisplayMs - elapsed;
                if (remaining > 0) {
                    setTimeout(() => { indicator.style.display = 'none'; }, remaining);
                } else {
                    indicator.style.display = 'none';
                }
            }
        }

        class TerminalConnection {
            constructor(container, wsPath, title, readOnly = false) {
                this.wsPath = wsPath;
                this.title = title;
                this.container = container;
                this.readOnly = readOnly;
                this.term = null;
                this.ws = null;
                this.fitAddon = null;
                this.webLinksAddon = null;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 10;
                this.baseDelay = 1000;
                this.maxDelay = 30000;
                this.shouldReconnect = true;
                this.resizeTimeout = null;
                this.resizeHandler = null;
            }

            initTerminal() {
                this.container.innerHTML = '';
                this.term = new Terminal({
                    cursorBlink: true,
                    scrollback: 10000,
                    altScrollPassthrough: true,
                    fontFamily: '"JetBrains Mono", "Fira Code", "SF Mono", Menlo, Monaco, "Courier New", monospace',
                    fontSize: 14,
                    fontWeight: 400,
                    fontWeightBold: 600,
                    letterSpacing: 0,
                    lineHeight: 1.2,
                    theme: {
                        background: '#0a0a0f',
                        foreground: '#e0e0e0',
                        cursor: '#00f5ff',
                        cursorAccent: '#0a0a0f',
                        selectionBackground: '#004d4f',
                        selectionForeground: '#ffffff',
                        selectionInactiveBackground: '#004d4f50',
                        black: '#505060',
                        red: '#ff0055',
                        green: '#00f5ff',
                        yellow: '#ffaa00',
                        blue: '#00a5aa',
                        magenta: '#ff0055',
                        cyan: '#00f5ff',
                        white: '#e0e0e0',
                        brightBlack: '#808090',
                        brightRed: '#ff3377',
                        brightGreen: '#33ffff',
                        brightYellow: '#ffcc33',
                        brightBlue: '#33cccc',
                        brightMagenta: '#ff3377',
                        brightCyan: '#33ffff',
                        brightWhite: '#ffffff'
                    }
                });
                this.fitAddon = new FitAddon.FitAddon();
                this.term.loadAddon(this.fitAddon);
                this.webLinksAddon = new WebLinksAddon.WebLinksAddon();
                this.term.loadAddon(this.webLinksAddon);
                this.term.open(this.container);
                this.fitAddon.fit();

                this.term.element.addEventListener('wheel', (e) => {
                    const buffer = this.term.buffer.active;
                    if (buffer.type === 'alternate') {
                        return;
                    }
                    const atTop = buffer.viewportY === 0;
                    const atBottom = buffer.viewportY >= buffer.baseY;
                    const scrollingUp = e.deltaY < 0;
                    const scrollingDown = e.deltaY > 0;

                    if ((scrollingDown && atBottom) || (scrollingUp && atTop)) {
                        e.stopPropagation();
                        e.preventDefault();
                    }
                }, { capture: true, passive: false });

                if (!this.readOnly) {
                    this.term.onData((data) => {
                        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                            this.ws.send(buildTerminalMessage(MSG_DATA, data));
                        }
                    });
                }

                this.resizeHandler = () => {
                    this.fitAddon.fit();
                    this.sendResize();
                };
                window.addEventListener('resize', this.resizeHandler);
            }

            connect() {
                if (!this.term) {
                    this.initTerminal();
                }

                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                this.ws = new WebSocket(`${protocol}//${window.location.host}${this.wsPath}`);
                this.ws.binaryType = 'arraybuffer';

                this.updateStatus('connecting');

                this.ws.onopen = () => {
                    this.reconnectAttempts = 0;
                    this.updateStatus('connected');
                    const initData = JSON.stringify({
                        cols: this.term.cols,
                        rows: this.term.rows
                    });
                    this.ws.send(initData);
                };

                this.ws.onmessage = (event) => {
                    const data = new Uint8Array(event.data);
                    if (data.length > 0 && data[0] === MSG_DATA) {
                        this.term.write(data.slice(1));
                    }
                };

                this.ws.onerror = () => {
                    this.updateStatus('error');
                };

                this.ws.onclose = (event) => {
                    this.updateStatus('disconnected');
                    if (this.shouldReconnect && !event.wasClean) {
                        this.scheduleReconnect();
                    } else if (this.shouldReconnect) {
                        this.term.write('\r\n[Connection closed]\r\n');
                    }
                };
            }

            scheduleReconnect() {
                if (this.reconnectAttempts >= this.maxReconnectAttempts) {
                    this.term.write('\r\n[Max reconnection attempts reached]\r\n');
                    this.updateReconnectInfo('Max attempts reached');
                    return;
                }

                const delay = Math.min(
                    this.baseDelay * Math.pow(2, this.reconnectAttempts),
                    this.maxDelay
                );
                this.reconnectAttempts++;

                this.updateReconnectInfo(`Reconnecting in ${delay/1000}s (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);

                setTimeout(() => {
                    if (this.shouldReconnect) {
                        this.updateReconnectInfo('');
                        this.connect();
                    }
                }, delay);
            }

            updateStatus(status) {
                const statusEl = document.getElementById('terminal-status');
                statusEl.className = 'terminal-status ' + status;
            }

            updateReconnectInfo(text) {
                const infoEl = document.getElementById('reconnect-info');
                infoEl.textContent = text;
            }

            sendResize() {
                clearTimeout(this.resizeTimeout);
                this.resizeTimeout = setTimeout(() => {
                    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                        const json = JSON.stringify({columns: this.term.cols, rows: this.term.rows});
                        this.ws.send(buildTerminalMessage(MSG_RESIZE, json));
                    }
                }, 100);
            }

            dispose() {
                this.shouldReconnect = false;
                clearTimeout(this.resizeTimeout);
                if (this.resizeHandler) {
                    window.removeEventListener('resize', this.resizeHandler);
                    this.resizeHandler = null;
                }
                if (this.ws) {
                    this.ws.close();
                    this.ws = null;
                }
                if (this.term) {
                    this.term.dispose();
                    this.term = null;
                }
            }
        }

        async function checkAuth() {
            try {
                const resp = await fetch('/api/auth/status');
                const data = await resp.json();
                const badge = document.getElementById('auth-badge');
                if (data.authenticated) {
                    badge.classList.remove('unauthenticated');
                    badge.classList.add('authenticated');
                    badge.textContent = 'ADMIN';
                } else {
                    badge.classList.remove('authenticated');
                    badge.classList.add('unauthenticated');
                    badge.textContent = 'AUTH';
                }
            } catch (e) {
                console.error('Failed to check auth:', e);
            }
        }

        let sleevesCache = [];

        async function refreshSleeves() {
            try {
                const resp = await fetch('/api/sleeves');
                const sleeves = await resp.json();
                sleevesCache = sleeves;
                const grid = document.getElementById('sleeves-grid');
                const statActive = document.getElementById('stat-active');

                statActive.textContent = sleeves.length;

                if (sleeves.length === 0) {
                    grid.innerHTML = '<div class="empty-state">No sleeves running. Click "+ SPAWN SLEEVE" to create one.</div>';
                    return;
                }

                grid.innerHTML = sleeves.map(s => `
                    <div class="sleeve-card healthy">
                        <div class="sleeve-header">
                            <span class="sleeve-name">SLEEVE: ${escapeHtml(s.name)}</span>
                            <span class="sleeve-status active">ACTIVE</span>
                        </div>
                        <div class="sleeve-body">
                            <div class="sleeve-row">
                                <span class="sleeve-label">DHF</span>
                                <span class="sleeve-value">Claude Code</span>
                            </div>
                            <div class="sleeve-row">
                                <span class="sleeve-label">Workspace</span>
                                <span class="sleeve-value">${escapeHtml(s.workspace)}</span>
                            </div>
                            <div class="sleeve-row">
                                <span class="sleeve-label">Container</span>
                                <span class="sleeve-value" style="font-size: var(--text-sm); color: var(--text-secondary);">${escapeHtml(s.container_id)}</span>
                            </div>
                        </div>
                        <div class="sleeve-actions">
                            <button class="btn" onclick="openTerminal('${escapeHtml(s.name)}')">TERMINAL</button>
                            <button class="btn" onclick="openTerminalObserve('${escapeHtml(s.name)}')">OBSERVE</button>
                            <button class="btn btn-danger" onclick="killSleeve('${escapeHtml(s.name)}')">KILL</button>
                        </div>
                    </div>
                `).join('');

                updateNeedlecastSleeveList();
            } catch (e) {
                console.error('Failed to fetch sleeves:', e);
            }
        }

        function updateNeedlecastSleeveList() {
            const list = document.getElementById('needlecast-sleeve-list');
            if (!list) return;
            list.innerHTML = sleevesCache.map(s =>
                `<div class="needlecast-sleeve-item">${escapeHtml(s.name)}</div>`
            ).join('');
        }

        let workspacesCache = [];

        async function refreshWorkspaces() {
            try {
                const resp = await fetch('/api/workspaces');
                workspacesCache = await resp.json();
                updateWorkspaceSelect();
            } catch (e) {
                console.error('Failed to fetch workspaces:', e);
            }
        }

        async function refreshWorkspacesTable() {
            try {
                const resp = await fetch('/api/workspaces');
                const workspaces = await resp.json();
                const tbody = document.querySelector('#workspaces-table tbody');
                const emptyState = document.getElementById('workspaces-empty');
                const table = document.getElementById('workspaces-table');

                if (workspaces.length === 0) {
                    table.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                    return;
                }

                table.classList.remove('hidden');
                emptyState.classList.add('hidden');

                tbody.innerHTML = workspaces.map(ws => {
                    const branch = formatGitBranch(ws.git);
                    const gitStatus = formatGitStatus(ws.git, ws.in_use);
                    const cstackStatus = formatCstackStatus(ws.cstack, ws);
                    const lastCommit = formatLastCommit(ws.git);
                    const sleeve = ws.sleeve_name || '-';
                    const actions = formatWorkspaceActions(ws);
                    return `
                    <tr>
                        <td>${ws.name}</td>
                        <td>${branch}</td>
                        <td>${gitStatus}</td>
                        <td>${cstackStatus}</td>
                        <td>${lastCommit}</td>
                        <td>${sleeve}</td>
                        <td>${actions}</td>
                    </tr>
                    `;
                }).join('');
            } catch (e) {
                console.error('Failed to fetch workspaces:', e);
            }
        }

        function formatGitBranch(git) {
            if (!git) return '<span class="git-no-repo">-</span>';
            const branchClass = git.is_detached ? 'git-detached' : 'git-branch';
            const prefix = git.is_detached ? 'detached@' : '';
            return `<span class="${branchClass}">${prefix}${git.branch}</span>`;
        }

        function formatGitStatus(git, inUse) {
            if (!git) return '-';
            const parts = [];

            if (git.is_dirty) {
                parts.push(`<span class="git-dirty">${git.uncommitted_count} uncommitted</span>`);
            } else {
                parts.push('<span class="git-clean">Clean</span>');
            }

            if (git.ahead_count > 0 || git.behind_count > 0) {
                const syncParts = [];
                if (git.ahead_count > 0) syncParts.push(`${git.ahead_count} ahead`);
                if (git.behind_count > 0) syncParts.push(`${git.behind_count} behind`);
                const syncClass = git.behind_count > 0 ? 'git-behind' : 'git-ahead';
                parts.push(`<span class="${syncClass}">${syncParts.join(', ')}</span>`);
            }

            return parts.join(' / ');
        }

        function formatLastCommit(git) {
            if (!git || !git.last_commit_hash) return '-';
            const msg = git.last_commit_msg.length > 30
                ? git.last_commit_msg.substring(0, 30) + '...'
                : git.last_commit_msg;
            return `<span class="git-commit-hash">${git.last_commit_hash}</span> ${msg} <span class="git-commit-time">(${git.last_commit_time})</span>`;
        }

        function formatWorkspaceActions(ws) {
            const isGitRepo = !!ws.git;
            const canSwitch = isGitRepo && !ws.in_use && !ws.git.is_dirty;
            const canPull = isGitRepo && !ws.in_use && !ws.git.is_dirty && ws.git.ahead_count === 0 && ws.git.behind_count > 0;
            const canCommit = isGitRepo && !ws.in_use && ws.git.is_dirty;
            const canPush = isGitRepo && !ws.in_use && ws.git.ahead_count > 0;

            const switchDisabled = !canSwitch ? 'disabled' : '';
            const fetchDisabled = !isGitRepo ? 'disabled' : '';
            const pullDisabled = !canPull ? 'disabled' : '';
            const commitDisabled = !canCommit ? 'disabled' : '';
            const pushDisabled = !canPush ? 'disabled' : '';

            let switchTitle = 'Switch branch';
            if (!isGitRepo) {
                switchTitle = 'Not a git repository';
            } else if (ws.in_use) {
                switchTitle = 'Workspace in use by ' + ws.sleeve_name;
            } else if (ws.git.is_dirty) {
                switchTitle = 'Has uncommitted changes';
            }

            let pullTitle = 'Pull from remote';
            if (!isGitRepo) {
                pullTitle = 'Not a git repository';
            } else if (ws.in_use) {
                pullTitle = 'Workspace in use by ' + ws.sleeve_name;
            } else if (ws.git.is_dirty) {
                pullTitle = 'Has uncommitted changes';
            } else if (ws.git.ahead_count > 0) {
                pullTitle = 'Has local commits - push first';
            } else if (ws.git.behind_count === 0) {
                pullTitle = 'Already up to date';
            }

            let commitTitle = 'Commit all changes';
            if (!isGitRepo) {
                commitTitle = 'Not a git repository';
            } else if (ws.in_use) {
                commitTitle = 'Workspace in use by ' + ws.sleeve_name;
            } else if (!ws.git.is_dirty) {
                commitTitle = 'No uncommitted changes';
            }

            let pushTitle = 'Push to remote';
            if (!isGitRepo) {
                pushTitle = 'Not a git repository';
            } else if (ws.in_use) {
                pushTitle = 'Workspace in use by ' + ws.sleeve_name;
            } else if (ws.git.ahead_count === 0) {
                pushTitle = 'No commits to push';
            }

            const escapedPath = ws.path.replace(/'/g, "\\'");
            const escapedName = ws.name.replace(/'/g, "\\'");

            return `<div class="action-buttons">
                <button class="btn btn-small" ${commitDisabled} title="${commitTitle}"
                        onclick="commitChanges('${escapedPath}', this)">Commit</button>
                <button class="btn btn-small" ${pushDisabled} title="${pushTitle}"
                        onclick="pushChanges('${escapedPath}', this)">Push</button>
                <button class="btn btn-small" ${switchDisabled} title="${switchTitle}"
                        onclick="showSwitchModal('${escapedPath}', '${escapedName}')">Switch</button>
                <button class="btn btn-small" ${fetchDisabled} title="${isGitRepo ? 'Fetch from remote' : 'Not a git repository'}"
                        onclick="fetchRemote('${escapedPath}', this)">Fetch</button>
                <button class="btn btn-small" ${pullDisabled} title="${pullTitle}"
                        onclick="pullRemote('${escapedPath}', this)">Pull</button>
                <button class="btn btn-small" disabled title="Open in IDE (coming soon)"
                        onclick="viewWorkspace('${escapedPath}')">View</button>
            </div>`;
        }

        let initializingCstackPaths = new Set();

        function formatCstackStatus(cstack, ws) {
            if (initializingCstackPaths.has(ws.path)) {
                return `<span style="color:var(--text-secondary)"><span class="inline-spinner"></span> Initializing...</span>`;
            }

            if (!cstack || !cstack.exists) {
                const escapedPath = ws.path.replace(/'/g, "\\'");
                return `<button class="btn btn-small"
                        onclick="showCstackInitModal('${escapedPath}', '${ws.name}')">
                    Init Stack
                </button>`;
            }

            const parts = [];
            if (cstack.ready > 0) {
                parts.push(`<span style="color:var(--cyan-glow);font-weight:600">${cstack.ready} ready</span>`);
            }
            if (cstack.in_progress > 0) {
                parts.push(`<span style="color:var(--cyan-dim)">${cstack.in_progress} active</span>`);
            }
            if (cstack.blocked > 0) {
                parts.push(`<span style="color:var(--magenta-glow)">${cstack.blocked} blocked</span>`);
            }
            if (cstack.open > 0 && cstack.ready === 0 && cstack.in_progress === 0) {
                parts.push(`<span style="color:var(--amber-glow)">${cstack.open} open</span>`);
            }

            if (parts.length === 0) {
                return `<span style="color:var(--text-secondary)">No tasks</span>`;
            }

            return parts.join(' / ');
        }

        let currentSwitchWsPath = '';

        async function showSwitchModal(wsPath, wsName) {
            currentSwitchWsPath = wsPath;
            document.getElementById('switch-ws-name').textContent = wsName;
            document.getElementById('switch-ws-path').value = wsPath;
            document.getElementById('switch-error').classList.add('hidden');
            document.getElementById('branch-select').innerHTML = '<option value="">Loading branches...</option>';
            document.getElementById('switch-branch-modal').classList.add('active');

            try {
                const resp = await fetch(`/api/workspaces/branches?workspace=${encodeURIComponent(wsPath)}`);
                if (!resp.ok) {
                    const err = await resp.text();
                    document.getElementById('switch-error').textContent = err;
                    document.getElementById('switch-error').classList.remove('hidden');
                    return;
                }

                const branches = await resp.json();
                const select = document.getElementById('branch-select');
                let options = '';

                if (branches.local && branches.local.length > 0) {
                    options += '<optgroup label="Local Branches">';
                    for (const b of branches.local) {
                        const selected = b === branches.current ? 'selected' : '';
                        const current = b === branches.current ? ' (current)' : '';
                        options += `<option value="${b}" ${selected}>${b}${current}</option>`;
                    }
                    options += '</optgroup>';
                }

                if (branches.remote && branches.remote.length > 0) {
                    options += '<optgroup label="Remote Branches">';
                    for (const b of branches.remote) {
                        options += `<option value="${b}">${b}</option>`;
                    }
                    options += '</optgroup>';
                }

                if (options === '') {
                    options = '<option value="">No branches found</option>';
                }

                select.innerHTML = options;
            } catch (e) {
                document.getElementById('switch-error').textContent = e.message;
                document.getElementById('switch-error').classList.remove('hidden');
            }
        }

        function hideSwitchModal() {
            document.getElementById('switch-branch-modal').classList.remove('active');
            document.getElementById('switch-form').reset();
            document.getElementById('switch-error').classList.add('hidden');
            hideSwitchLoading();
            currentSwitchWsPath = '';
        }

        function showSwitchLoading(msg) {
            document.querySelector('.switch-loading-text').textContent = msg || 'Switching branch...';
            document.getElementById('switch-loading').classList.add('active');
            document.getElementById('switch-submit-btn').disabled = true;
        }

        function hideSwitchLoading() {
            document.getElementById('switch-loading').classList.remove('active');
            document.getElementById('switch-submit-btn').disabled = false;
        }

        async function switchBranch(e) {
            e.preventDefault();
            const wsPath = document.getElementById('switch-ws-path').value;
            const branch = document.getElementById('branch-select').value;

            if (!branch) {
                document.getElementById('switch-error').textContent = 'Please select a branch';
                document.getElementById('switch-error').classList.remove('hidden');
                return;
            }

            showSwitchLoading('Switching to ' + branch + '...');
            document.getElementById('switch-error').classList.add('hidden');

            try {
                const resp = await fetch(`/api/workspaces/branches?workspace=${encodeURIComponent(wsPath)}&action=switch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ workspace: wsPath, branch: branch })
                });

                if (!resp.ok) {
                    const err = await resp.text();
                    document.getElementById('switch-error').textContent = err;
                    document.getElementById('switch-error').classList.remove('hidden');
                    hideSwitchLoading();
                    return;
                }

                hideSwitchLoading();
                hideSwitchModal();
                refreshWorkspacesTable();
            } catch (e) {
                hideSwitchLoading();
                document.getElementById('switch-error').textContent = e.message;
                document.getElementById('switch-error').classList.remove('hidden');
            }
        }

        async function fetchRemote(wsPath, btn) {
            const originalText = btn.textContent;
            btn.textContent = 'Fetching...';
            btn.disabled = true;

            try {
                const resp = await fetch(`/api/workspaces/branches?workspace=${encodeURIComponent(wsPath)}&action=fetch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ workspace: wsPath })
                });

                if (!resp.ok) {
                    const err = await resp.text();
                    alert('Fetch failed: ' + err);
                    btn.textContent = originalText;
                    btn.disabled = false;
                    return;
                }

                btn.textContent = 'Done!';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                    refreshWorkspacesTable();
                }, 1000);
            } catch (e) {
                alert('Fetch failed: ' + e.message);
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        async function pullRemote(wsPath, btn) {
            const originalText = btn.textContent;
            btn.textContent = 'Pulling...';
            btn.disabled = true;

            try {
                const resp = await fetch(`/api/workspaces/branches?workspace=${encodeURIComponent(wsPath)}&action=pull`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ workspace: wsPath })
                });

                if (!resp.ok) {
                    const err = await resp.text();
                    alert('Pull failed: ' + err);
                    btn.textContent = originalText;
                    btn.disabled = false;
                    return;
                }

                const result = await resp.json();
                if (!result.success) {
                    alert('Pull failed: ' + (result.message || 'unknown error'));
                    btn.textContent = originalText;
                    btn.disabled = false;
                    return;
                }

                btn.textContent = 'Done!';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                    refreshWorkspacesTable();
                }, 1000);
            } catch (e) {
                alert('Pull failed: ' + e.message);
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        async function commitChanges(wsPath, btn) {
            const originalText = btn.textContent;
            btn.textContent = 'Committing...';
            btn.disabled = true;

            try {
                const resp = await fetch(`/api/workspaces/branches?workspace=${encodeURIComponent(wsPath)}&action=commit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!resp.ok) {
                    const err = await resp.text();
                    alert('Commit failed: ' + err);
                    btn.textContent = originalText;
                    btn.disabled = false;
                    return;
                }

                const result = await resp.json();
                if (!result.success) {
                    alert('Commit failed: ' + (result.message || 'unknown error'));
                    btn.textContent = originalText;
                    btn.disabled = false;
                    return;
                }

                btn.textContent = 'Done!';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                    refreshWorkspacesTable();
                }, 1000);
            } catch (e) {
                alert('Commit failed: ' + e.message);
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        async function pushChanges(wsPath, btn) {
            const originalText = btn.textContent;
            btn.textContent = 'Pushing...';
            btn.disabled = true;

            try {
                const resp = await fetch(`/api/workspaces/branches?workspace=${encodeURIComponent(wsPath)}&action=push`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!resp.ok) {
                    const err = await resp.text();
                    alert('Push failed: ' + err);
                    btn.textContent = originalText;
                    btn.disabled = false;
                    return;
                }

                const result = await resp.json();
                if (!result.success) {
                    alert('Push failed: ' + (result.message || 'unknown error'));
                    btn.textContent = originalText;
                    btn.disabled = false;
                    return;
                }

                btn.textContent = 'Done!';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                    refreshWorkspacesTable();
                }, 1000);
            } catch (e) {
                alert('Push failed: ' + e.message);
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function viewWorkspace(wsPath) {
            alert('View workspace coming soon. Options: LazyGit, VS Code (code-server), or web file browser.');
        }

        function showCstackInitModal(wsPath, wsName) {
            document.getElementById('cstack-init-ws-name').textContent = wsName;
            document.getElementById('cstack-init-ws-path').value = wsPath;
            document.getElementById('cstack-init-error').classList.add('hidden');
            document.getElementById('cstack-init-modal').classList.add('active');
        }

        function hideCstackInitModal() {
            document.getElementById('cstack-init-modal').classList.remove('active');
            document.getElementById('cstack-init-form').reset();
            document.getElementById('cstack-init-error').classList.add('hidden');
        }

        async function initCstack(e) {
            e.preventDefault();
            const wsPath = document.getElementById('cstack-init-ws-path').value;
            const mode = document.querySelector('input[name="cstack-mode"]:checked').value;

            hideCstackInitModal();
            initializingCstackPaths.add(wsPath);
            await refreshWorkspacesTable();

            try {
                const resp = await fetch(
                    `/api/workspaces/cstack?workspace=${encodeURIComponent(wsPath)}&action=init`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ mode: mode })
                    }
                );

                const result = await resp.json();
                initializingCstackPaths.delete(wsPath);

                if (!result.success && result.error && !result.error.includes('already')) {
                    alert('Cstack init failed: ' + result.error);
                }

                await refreshWorkspacesTable();

            } catch (err) {
                initializingCstackPaths.delete(wsPath);
                alert('Cstack init failed: ' + err.message);
                await refreshWorkspacesTable();
            }
        }

        function updateWorkspaceSelect() {
            const select = document.getElementById('existing-workspace-select');
            const available = workspacesCache.filter(ws => !ws.in_use);
            if (available.length === 0) {
                select.innerHTML = '<option value="">No available workspaces</option>';
                return;
            }
            select.innerHTML = available.map(ws =>
                `<option value="${ws.path}">${ws.name}</option>`
            ).join('');
        }

        function toggleWorkspaceMode() {
            const mode = document.querySelector('input[name="ws-mode"]:checked').value;
            const newGroup = document.getElementById('new-ws-group');
            const existingGroup = document.getElementById('existing-ws-group');
            const newInput = document.getElementById('new-workspace-input');
            const existingSelect = document.getElementById('existing-workspace-select');

            newGroup.classList.add('hidden');
            existingGroup.classList.add('hidden');
            newInput.required = false;
            existingSelect.required = false;

            if (mode === 'new') {
                newGroup.classList.remove('hidden');
                newInput.required = true;
            } else if (mode === 'existing') {
                existingGroup.classList.remove('hidden');
                existingSelect.required = true;
            }
        }

        async function showSpawnModal() {
            await refreshWorkspaces();
            toggleWorkspaceMode();
            document.getElementById('spawn-modal').classList.add('active');
        }

        function hideSpawnModal() {
            document.getElementById('spawn-modal').classList.remove('active');
            document.getElementById('spawn-form').reset();
            hideSpawnLoading();
            toggleWorkspaceMode();
        }

        function showSpawnLoading(msg) {
            document.querySelector('.spawn-loading-text').textContent = msg || 'Spawning sleeve...';
            document.getElementById('spawn-loading').classList.add('active');
        }

        function hideSpawnLoading() {
            document.getElementById('spawn-loading').classList.remove('active');
        }

        function showCloneModal() {
            document.getElementById('clone-modal').classList.add('active');
            document.getElementById('clone-error').classList.add('hidden');
        }

        function hideCloneModal() {
            document.getElementById('clone-modal').classList.remove('active');
            document.getElementById('clone-form').reset();
            document.getElementById('clone-error').classList.add('hidden');
            hideCloneLoading();
            stopClonePolling();
        }

        function showCloneLoading(msg) {
            document.querySelector('.clone-loading-text').textContent = msg || 'Cloning repository...';
            document.getElementById('clone-loading').classList.add('active');
            document.getElementById('clone-submit-btn').disabled = true;
        }

        function hideCloneLoading() {
            document.getElementById('clone-loading').classList.remove('active');
            document.getElementById('clone-submit-btn').disabled = false;
        }

        function stopClonePolling() {
            if (clonePollingInterval) {
                clearInterval(clonePollingInterval);
                clonePollingInterval = null;
            }
            currentCloneJobId = null;
        }

        async function cloneWorkspace(e) {
            e.preventDefault();
            const repoUrl = document.getElementById('clone-url-input').value;
            const name = document.getElementById('clone-name-input').value;

            if (!repoUrl) {
                alert('Please enter a repository URL');
                return;
            }

            showCloneLoading('Starting clone...');
            document.getElementById('clone-error').classList.add('hidden');

            try {
                const resp = await fetch('/api/workspaces/clone', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ repo_url: repoUrl, name: name || undefined })
                });

                if (!resp.ok) {
                    const err = await resp.text();
                    document.getElementById('clone-error').textContent = err;
                    document.getElementById('clone-error').classList.remove('hidden');
                    hideCloneLoading();
                    return;
                }

                const job = await resp.json();
                currentCloneJobId = job.id;
                showCloneLoading('Cloning repository...');

                clonePollingInterval = setInterval(async () => {
                    try {
                        const statusResp = await fetch(`/api/workspaces/clone?id=${currentCloneJobId}`);
                        const jobStatus = await statusResp.json();

                        if (jobStatus.status === 'completed') {
                            stopClonePolling();
                            hideCloneLoading();
                            hideCloneModal();
                            refreshWorkspacesTable();
                            refreshWorkspaces();
                        } else if (jobStatus.status === 'failed') {
                            stopClonePolling();
                            hideCloneLoading();
                            document.getElementById('clone-error').textContent = jobStatus.error || 'Clone failed';
                            document.getElementById('clone-error').classList.remove('hidden');
                        }
                    } catch (pollErr) {
                        console.error('Failed to poll clone status:', pollErr);
                    }
                }, 1000);

            } catch (e) {
                hideCloneLoading();
                document.getElementById('clone-error').textContent = e.message;
                document.getElementById('clone-error').classList.remove('hidden');
            }
        }

        async function spawnSleeve(e) {
            e.preventDefault();
            const mode = document.querySelector('input[name="ws-mode"]:checked').value;
            const name = document.getElementById('name-input').value;
            let workspace;

            try {
                if (mode === 'new') {
                    const wsName = document.getElementById('new-workspace-input').value;
                    if (!wsName) {
                        alert('Please enter a workspace name');
                        return;
                    }
                    showSpawnLoading('Creating workspace...');
                    const createResp = await fetch('/api/workspaces', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: wsName })
                    });
                    if (!createResp.ok) {
                        hideSpawnLoading();
                        const err = await createResp.text();
                        alert('Failed to create workspace: ' + err);
                        return;
                    }
                    const wsData = await createResp.json();
                    workspace = wsData.path;
                } else if (mode === 'existing') {
                    workspace = document.getElementById('existing-workspace-select').value;
                    if (!workspace) {
                        alert('Please select a workspace');
                        return;
                    }
                }

                showSpawnLoading('Spawning sleeve...');
                const body = { workspace, name: name || undefined };
                const resp = await fetch('/api/sleeves', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!resp.ok) {
                    hideSpawnLoading();
                    const err = await resp.text();
                    alert('Failed to spawn sleeve: ' + err);
                    return;
                }

                hideSpawnLoading();
                hideSpawnModal();
                refreshSleeves();
            } catch (e) {
                hideSpawnLoading();
                console.error('Failed to spawn sleeve:', e);
                alert('Failed to spawn sleeve: ' + e.message);
            }
        }

        async function killSleeve(name) {
            if (!confirm(`Are you sure you want to kill sleeve "${name}"?`)) {
                return;
            }

            try {
                const resp = await fetch(`/api/sleeves/${name}`, { method: 'DELETE' });
                if (!resp.ok) {
                    const err = await resp.text();
                    alert('Failed to kill sleeve: ' + err);
                    return;
                }
                refreshSleeves();
            } catch (e) {
                console.error('Failed to kill sleeve:', e);
            }
        }

        function openTerminalWithPath(title, wsPath, readOnly = false) {
            document.getElementById('terminal-title').textContent = title;
            document.getElementById('terminal-modal').classList.add('active');
            document.getElementById('reconnect-info').textContent = '';

            const readOnlyBadge = document.getElementById('terminal-readonly-badge');
            if (readOnly) {
                readOnlyBadge.classList.add('active');
            } else {
                readOnlyBadge.classList.remove('active');
            }

            const container = document.getElementById('terminal-container');

            if (currentConnection) {
                currentConnection.dispose();
            }

            currentConnection = new TerminalConnection(container, wsPath, title, readOnly);
            currentConnection.connect();
        }

        function openTerminal(name) {
            openTerminalWithPath(`Terminal - ${name}`, `/sleeves/${name}/terminal`);
        }

        function openTerminalObserve(name) {
            openTerminalWithPath(`Terminal - ${name} (Observe)`, `/sleeves/${name}/terminal?mode=observe`, true);
        }

        function openEnvoyTerminal() {
            openTerminalWithPath('Terminal - Envoy (Poe)', '/envoy/terminal');
        }

        function hideTerminalModal() {
            document.getElementById('terminal-modal').classList.remove('active');
            if (currentConnection) {
                currentConnection.dispose();
                currentConnection = null;
            }
        }

        checkAuth();
        refreshSleeves();

        setInterval(() => {
            refreshSleeves();
        }, 5000);
    </script>
</body>
</html>
