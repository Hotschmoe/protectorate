<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protectorate Envoy</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            background: #0d1117;
            color: #c9d1d9;
            min-height: 100vh;
        }
        .header {
            background: #161b22;
            border-bottom: 1px solid #30363d;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: 600;
            color: #58a6ff;
        }
        .auth-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .auth-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #f85149;
        }
        .auth-indicator.authenticated { background: #3fb950; }
        .tabs {
            background: #161b22;
            border-bottom: 1px solid #30363d;
            padding: 0 2rem;
            display: flex;
            gap: 0;
        }
        .tab {
            padding: 0.75rem 1.5rem;
            color: #8b949e;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.15s;
        }
        .tab:hover { color: #c9d1d9; }
        .tab.active {
            color: #c9d1d9;
            border-bottom-color: #f78166;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .main {
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        .panel {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
        }
        .panel-header {
            padding: 1rem;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panel-title { font-weight: 600; }
        .panel-body { padding: 1rem; }
        .btn {
            background: #238636;
            color: #fff;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
        }
        .btn:hover { background: #2ea043; }
        .btn:disabled {
            background: #21262d;
            color: #6e7681;
            cursor: not-allowed;
        }
        .btn-danger { background: #da3633; }
        .btn-danger:hover { background: #f85149; }
        .btn-secondary {
            background: #21262d;
            border: 1px solid #30363d;
        }
        .btn-secondary:hover { background: #30363d; }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            text-align: left;
            padding: 0.75rem;
            border-bottom: 1px solid #21262d;
        }
        th { color: #8b949e; font-weight: 500; }
        .status-running { color: #3fb950; }
        .status-exited { color: #8b949e; }
        .status-available { color: #3fb950; }
        .status-in-use { color: #d29922; }
        .status-cloning { color: #58a6ff; }
        .sleeves-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }
        .sleeve-card {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 1rem;
        }
        .sleeve-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: #58a6ff;
        }
        .sleeve-meta {
            font-size: 0.875rem;
            color: #8b949e;
            margin-bottom: 1rem;
        }
        .sleeve-actions {
            display: flex;
            gap: 0.5rem;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 2rem;
            width: 400px;
            position: relative;
        }
        .modal-title {
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }
        .form-group { margin-bottom: 1rem; }
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: #8b949e;
        }
        .form-input {
            width: 100%;
            padding: 0.5rem;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
        }
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        .terminal-modal {
            width: 80%;
            height: 70%;
            padding: 0;
        }
        .terminal-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .terminal-container {
            height: calc(100% - 50px);
            padding: 0.5rem;
        }
        .full-width { grid-column: 1 / -1; }
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #8b949e;
        }
        .spawn-loading {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(22, 27, 34, 0.95);
            border-radius: 6px;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 1rem;
        }
        .spawn-loading.active { display: flex; }
        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid #30363d;
            border-top-color: #58a6ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spawn-loading-text {
            color: #8b949e;
            font-size: 0.9rem;
        }
        .radio-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .radio-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        .radio-option input { cursor: pointer; }
        .form-select {
            width: 100%;
            padding: 0.5rem;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
        }
        .form-select option { background: #0d1117; }
        .form-select option:disabled { color: #6e7681; }
        .hidden { display: none; }
        .terminal-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 8px;
            vertical-align: middle;
            background: #8b949e;
        }
        .terminal-status.connected { background: #3fb950; }
        .terminal-status.connecting { background: #d29922; animation: pulse 1s infinite; }
        .terminal-status.disconnected { background: #f85149; }
        .terminal-status.error { background: #f85149; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .reconnect-info {
            font-size: 0.75rem;
            color: #8b949e;
            margin-left: 0.5rem;
        }
        .error-text {
            color: #f85149;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        .git-branch { color: #a371f7; font-family: monospace; }
        .git-detached { color: #d29922; font-family: monospace; }
        .git-no-repo { color: #6e7681; }
        .git-clean { color: #3fb950; }
        .git-dirty { color: #f85149; }
        .git-ahead { color: #58a6ff; }
        .git-behind { color: #d29922; }
        .git-commit-hash { color: #8b949e; font-family: monospace; }
        .git-commit-time { color: #6e7681; font-size: 0.85em; }
        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            margin-right: 0.25rem;
        }
        .btn-small:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .action-buttons {
            display: flex;
            gap: 0.25rem;
        }
        .fetch-indicator {
            color: #6e7681;
            font-size: 0.85rem;
            margin-right: 1rem;
            animation: blink 1s ease-in-out infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        .inline-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #30363d;
            border-top-color: #58a6ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-right: 6px;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">Protectorate Envoy</div>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <button class="btn btn-secondary" onclick="openEnvoyTerminal()">Envoy Terminal</button>
            <div class="auth-status">
                <span>Claude Auth:</span>
                <div id="auth-indicator" class="auth-indicator"></div>
            </div>
        </div>
    </header>

    <nav class="tabs">
        <div class="tab active" onclick="switchTab('dashboard')">Dashboard</div>
        <div class="tab" onclick="switchTab('workspaces')">Workspaces</div>
    </nav>

    <div id="tab-dashboard" class="tab-content active">
        <main class="main">
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">Docker Containers</span>
                    <button class="btn btn-secondary" onclick="refreshContainers()">Refresh</button>
                </div>
                <div class="panel-body">
                    <table id="containers-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Image</th>
                                <th>Version</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">Docker Networks</span>
                </div>
                <div class="panel-body">
                    <table id="networks-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Driver</th>
                                <th>Scope</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="panel full-width">
                <div class="panel-header">
                    <span class="panel-title">Sleeves</span>
                    <button class="btn" onclick="showSpawnModal()">+ Spawn Sleeve</button>
                </div>
                <div class="panel-body">
                    <div id="sleeves-grid" class="sleeves-grid">
                        <div class="empty-state">No sleeves running. Click "+ Spawn Sleeve" to create one.</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="tab-workspaces" class="tab-content">
        <main class="main">
            <div class="panel full-width">
                <div class="panel-header">
                    <span class="panel-title">Workspaces</span>
                    <div style="display: flex; align-items: center;">
                        <span id="fetch-indicator" class="fetch-indicator" style="display: none;">fetching...</span>
                        <button class="btn" onclick="showCloneModal()">+ Clone from Git</button>
                    </div>
                </div>
                <div class="panel-body">
                    <table id="workspaces-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Branch</th>
                                <th>Git Status</th>
                                <th>Cstack</th>
                                <th>Last Commit</th>
                                <th>Sleeve</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <div id="workspaces-empty" class="empty-state hidden">
                        No workspaces yet. Click "+ Clone from Git" to clone a repository.
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="spawn-modal" class="modal">
        <div class="modal-content">
            <div id="spawn-loading" class="spawn-loading">
                <div class="spinner"></div>
                <div class="spawn-loading-text">Spawning sleeve...</div>
            </div>
            <h2 class="modal-title">Spawn New Sleeve</h2>
            <form id="spawn-form" onsubmit="spawnSleeve(event)">
                <div class="form-group">
                    <label class="form-label">Workspace</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="ws-mode" value="existing" checked onchange="toggleWorkspaceMode()">
                            Use existing
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="ws-mode" value="new" onchange="toggleWorkspaceMode()">
                            Create new
                        </label>
                    </div>
                </div>
                <div class="form-group" id="existing-ws-group">
                    <label class="form-label">Select Workspace</label>
                    <select class="form-select" id="existing-workspace-select" required>
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="form-group hidden" id="new-ws-group">
                    <label class="form-label">Workspace Name</label>
                    <input type="text" class="form-input" id="new-workspace-input"
                           placeholder="my-project" pattern="[a-zA-Z0-9_-]+"
                           title="Letters, numbers, dashes, underscores only">
                </div>
                <div class="form-group">
                    <label class="form-label">Sleeve Name (optional)</label>
                    <input type="text" class="form-input" id="name-input"
                           placeholder="Auto-assigned from pool">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideSpawnModal()">Cancel</button>
                    <button type="submit" class="btn">Spawn</button>
                </div>
            </form>
        </div>
    </div>

    <div id="clone-modal" class="modal">
        <div class="modal-content">
            <div id="clone-loading" class="spawn-loading">
                <div class="spinner"></div>
                <div class="clone-loading-text">Cloning repository...</div>
            </div>
            <h2 class="modal-title">Clone Repository</h2>
            <form id="clone-form" onsubmit="cloneWorkspace(event)">
                <div class="form-group">
                    <label class="form-label">Repository URL</label>
                    <input type="url" class="form-input" id="clone-url-input"
                           placeholder="https://github.com/owner/repo"
                           pattern="https://.*"
                           title="HTTPS URLs only"
                           required>
                </div>
                <div class="form-group">
                    <label class="form-label">Workspace Name (optional)</label>
                    <input type="text" class="form-input" id="clone-name-input"
                           placeholder="Auto-derived from repo URL"
                           pattern="[a-zA-Z0-9_-]*"
                           title="Letters, numbers, dashes, underscores only">
                </div>
                <div id="clone-error" class="error-text hidden"></div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideCloneModal()">Cancel</button>
                    <button type="submit" class="btn" id="clone-submit-btn">Clone</button>
                </div>
            </form>
        </div>
    </div>

    <div id="switch-branch-modal" class="modal">
        <div class="modal-content">
            <div id="switch-loading" class="spawn-loading">
                <div class="spinner"></div>
                <div class="switch-loading-text">Switching branch...</div>
            </div>
            <h2 class="modal-title">Switch Branch</h2>
            <p style="margin-bottom: 1rem;">Workspace: <strong id="switch-ws-name"></strong></p>
            <form id="switch-form" onsubmit="switchBranch(event)">
                <div class="form-group">
                    <label class="form-label">Select Branch</label>
                    <select class="form-select" id="branch-select" required>
                        <option value="">Loading branches...</option>
                    </select>
                </div>
                <div id="switch-error" class="error-text hidden"></div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideSwitchModal()">Cancel</button>
                    <button type="submit" class="btn" id="switch-submit-btn">Switch</button>
                </div>
            </form>
            <input type="hidden" id="switch-ws-path">
        </div>
    </div>

    <div id="cstack-init-modal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Initialize Cstack</h2>
            <p>Workspace: <strong id="cstack-init-ws-name"></strong></p>

            <form id="cstack-init-form" onsubmit="initCstack(event)">
                <div class="form-group">
                    <label class="form-label">Choose initialization mode:</label>

                    <div style="margin:0.75rem 0;padding:0.75rem;background:#0d1117;border:1px solid #30363d;border-radius:6px">
                        <label style="display:flex;align-items:start;cursor:pointer">
                            <input type="radio" name="cstack-mode" value="minimal" checked style="margin-top:4px">
                            <div style="margin-left:0.5rem">
                                <strong>Minimal</strong>
                                <div style="color:#8b949e;font-size:0.85rem">Create empty .cstack/ directory</div>
                            </div>
                        </label>
                    </div>

                    <div style="margin:0.75rem 0;padding:0.75rem;background:#0d1117;border:1px solid #30363d;border-radius:6px">
                        <label style="display:flex;align-items:start;cursor:pointer">
                            <input type="radio" name="cstack-mode" value="interview" style="margin-top:4px">
                            <div style="margin-left:0.5rem">
                                <strong>Interview (Recommended)</strong>
                                <div style="color:#8b949e;font-size:0.85rem">Init + mark for Claude interview on sleeve spawn</div>
                            </div>
                        </label>
                    </div>
                </div>

                <div id="cstack-init-error" class="error-text hidden"></div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideCstackInitModal()">Cancel</button>
                    <button type="submit" class="btn" id="cstack-init-btn">Initialize</button>
                </div>
            </form>
            <input type="hidden" id="cstack-init-ws-path">
        </div>
    </div>

    <div id="terminal-modal" class="modal">
        <div class="modal-content terminal-modal">
            <div class="terminal-header">
                <div style="display: flex; align-items: center;">
                    <span id="terminal-title">Terminal</span>
                    <span id="terminal-status" class="terminal-status"></span>
                    <span id="reconnect-info" class="reconnect-info"></span>
                </div>
                <button class="btn btn-secondary" onclick="hideTerminalModal()">Close</button>
            </div>
            <div id="terminal-container" class="terminal-container"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <script>
        let currentConnection = null;
        let currentCloneJobId = null;
        let clonePollingInterval = null;
        let lastFetchAllTime = 0;
        const FETCH_ALL_THROTTLE_MS = 60000;

        const TTYD_INPUT = 48;
        const TTYD_RESIZE = 49;

        function buildTtydMessage(type, data) {
            const msg = new Uint8Array(data.length + 1);
            msg[0] = type;
            for (let i = 0; i < data.length; i++) {
                msg[i + 1] = data.charCodeAt(i);
            }
            return msg.buffer;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.tab:nth-child(${tabName === 'dashboard' ? 1 : 2})`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            if (tabName === 'workspaces') {
                refreshWorkspacesTable();
                triggerFetchAllThrottled();
            }
        }

        async function triggerFetchAllThrottled() {
            const now = Date.now();
            if (now - lastFetchAllTime < FETCH_ALL_THROTTLE_MS) {
                return;
            }
            lastFetchAllTime = now;

            const indicator = document.getElementById('fetch-indicator');
            indicator.style.display = 'inline';
            const startTime = Date.now();
            const minDisplayMs = 1500;

            try {
                await fetch('/api/workspaces/branches?action=fetch-all', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                refreshWorkspacesTable();
            } catch (e) {
                console.error('Fetch all failed:', e);
            } finally {
                const elapsed = Date.now() - startTime;
                const remaining = minDisplayMs - elapsed;
                if (remaining > 0) {
                    setTimeout(() => { indicator.style.display = 'none'; }, remaining);
                } else {
                    indicator.style.display = 'none';
                }
            }
        }

        class TerminalConnection {
            constructor(container, wsPath, title) {
                this.wsPath = wsPath;
                this.title = title;
                this.container = container;
                this.term = null;
                this.ws = null;
                this.fitAddon = null;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 10;
                this.baseDelay = 1000;
                this.maxDelay = 30000;
                this.shouldReconnect = true;
                this.resizeTimeout = null;
                this.resizeHandler = null;
            }

            initTerminal() {
                this.container.innerHTML = '';
                this.term = new Terminal({
                    cursorBlink: true,
                    theme: {
                        background: '#0d1117',
                        foreground: '#c9d1d9'
                    }
                });
                this.fitAddon = new FitAddon.FitAddon();
                this.term.loadAddon(this.fitAddon);
                this.term.open(this.container);
                this.fitAddon.fit();

                this.term.onData((data) => {
                    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                        this.ws.send(buildTtydMessage(TTYD_INPUT, data));
                    }
                });

                this.resizeHandler = () => {
                    this.fitAddon.fit();
                    this.sendResize();
                };
                window.addEventListener('resize', this.resizeHandler);
            }

            connect() {
                if (!this.term) {
                    this.initTerminal();
                }

                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                this.ws = new WebSocket(`${protocol}//${window.location.host}${this.wsPath}`, ['tty']);
                this.ws.binaryType = 'arraybuffer';

                this.updateStatus('connecting');

                this.ws.onopen = () => {
                    this.reconnectAttempts = 0;
                    this.updateStatus('connected');
                    const initData = JSON.stringify({
                        AuthToken: "",
                        columns: this.term.cols,
                        rows: this.term.rows
                    });
                    this.ws.send(initData);
                };

                this.ws.onmessage = (event) => {
                    const data = new Uint8Array(event.data);
                    if (data.length > 0 && data[0] === TTYD_INPUT) {
                        this.term.write(data.slice(1));
                    }
                };

                this.ws.onerror = () => {
                    this.updateStatus('error');
                };

                this.ws.onclose = (event) => {
                    this.updateStatus('disconnected');
                    if (this.shouldReconnect && !event.wasClean) {
                        this.scheduleReconnect();
                    } else if (this.shouldReconnect) {
                        this.term.write('\r\n[Connection closed]\r\n');
                    }
                };
            }

            scheduleReconnect() {
                if (this.reconnectAttempts >= this.maxReconnectAttempts) {
                    this.term.write('\r\n[Max reconnection attempts reached]\r\n');
                    this.updateReconnectInfo('Max attempts reached');
                    return;
                }

                const delay = Math.min(
                    this.baseDelay * Math.pow(2, this.reconnectAttempts),
                    this.maxDelay
                );
                this.reconnectAttempts++;

                this.updateReconnectInfo(`Reconnecting in ${delay/1000}s (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);

                setTimeout(() => {
                    if (this.shouldReconnect) {
                        this.updateReconnectInfo('');
                        this.connect();
                    }
                }, delay);
            }

            updateStatus(status) {
                const statusEl = document.getElementById('terminal-status');
                statusEl.className = 'terminal-status ' + status;
            }

            updateReconnectInfo(text) {
                const infoEl = document.getElementById('reconnect-info');
                infoEl.textContent = text;
            }

            sendResize() {
                clearTimeout(this.resizeTimeout);
                this.resizeTimeout = setTimeout(() => {
                    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                        const json = JSON.stringify({columns: this.term.cols, rows: this.term.rows});
                        this.ws.send(buildTtydMessage(TTYD_RESIZE, json));
                    }
                }, 100);
            }

            dispose() {
                this.shouldReconnect = false;
                clearTimeout(this.resizeTimeout);
                if (this.resizeHandler) {
                    window.removeEventListener('resize', this.resizeHandler);
                    this.resizeHandler = null;
                }
                if (this.ws) {
                    this.ws.close();
                    this.ws = null;
                }
                if (this.term) {
                    this.term.dispose();
                    this.term = null;
                }
            }
        }

        async function checkAuth() {
            try {
                const resp = await fetch('/api/auth/status');
                const data = await resp.json();
                const indicator = document.getElementById('auth-indicator');
                if (data.authenticated) {
                    indicator.classList.add('authenticated');
                } else {
                    indicator.classList.remove('authenticated');
                }
            } catch (e) {
                console.error('Failed to check auth:', e);
            }
        }

        function parseImageVersion(image) {
            const parts = image.split(':');
            if (parts.length > 1) {
                return { name: parts[0], version: parts.slice(1).join(':') };
            }
            return { name: image, version: 'latest' };
        }

        function formatImageDisplay(containerName, imageName) {
            if (containerName === 'envoy-dev' && imageName === 'protectorate/base') {
                return 'protectorate/envoy (dev->bin mnt)';
            }
            return imageName;
        }

        async function refreshContainers() {
            try {
                const resp = await fetch('/api/docker/containers');
                const containers = await resp.json();
                const tbody = document.querySelector('#containers-table tbody');
                tbody.innerHTML = containers.map(c => {
                    const { name: imageName, version } = parseImageVersion(c.image);
                    const displayName = formatImageDisplay(c.name, imageName);
                    return `
                    <tr>
                        <td>${c.name || c.id}</td>
                        <td>${displayName}</td>
                        <td>${version}</td>
                        <td class="status-${c.state}">${c.status}</td>
                    </tr>
                    `;
                }).join('');
            } catch (e) {
                console.error('Failed to fetch containers:', e);
            }
        }

        async function refreshNetworks() {
            try {
                const resp = await fetch('/api/docker/networks');
                const networks = await resp.json();
                const tbody = document.querySelector('#networks-table tbody');
                tbody.innerHTML = networks.map(n => `
                    <tr>
                        <td>${n.name}</td>
                        <td>${n.driver}</td>
                        <td>${n.scope}</td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Failed to fetch networks:', e);
            }
        }

        async function refreshSleeves() {
            try {
                const resp = await fetch('/api/sleeves');
                const sleeves = await resp.json();
                const grid = document.getElementById('sleeves-grid');

                if (sleeves.length === 0) {
                    grid.innerHTML = '<div class="empty-state">No sleeves running. Click "+ Spawn Sleeve" to create one.</div>';
                    return;
                }

                grid.innerHTML = sleeves.map(s => `
                    <div class="sleeve-card">
                        <div class="sleeve-name">${s.name}</div>
                        <div class="sleeve-meta">
                            <div>Container: ${s.container_id}</div>
                            <div>Workspace: ${s.workspace}</div>
                        </div>
                        <div class="sleeve-actions">
                            <button class="btn btn-secondary" onclick="openTerminal('${s.name}')">Terminal</button>
                            <button class="btn btn-danger" onclick="killSleeve('${s.name}')">Kill</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Failed to fetch sleeves:', e);
            }
        }

        let workspacesCache = [];

        async function refreshWorkspaces() {
            try {
                const resp = await fetch('/api/workspaces');
                workspacesCache = await resp.json();
                updateWorkspaceSelect();
            } catch (e) {
                console.error('Failed to fetch workspaces:', e);
            }
        }

        async function refreshWorkspacesTable() {
            try {
                const resp = await fetch('/api/workspaces');
                const workspaces = await resp.json();
                const tbody = document.querySelector('#workspaces-table tbody');
                const emptyState = document.getElementById('workspaces-empty');
                const table = document.getElementById('workspaces-table');

                if (workspaces.length === 0) {
                    table.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                    return;
                }

                table.classList.remove('hidden');
                emptyState.classList.add('hidden');

                tbody.innerHTML = workspaces.map(ws => {
                    const branch = formatGitBranch(ws.git);
                    const gitStatus = formatGitStatus(ws.git, ws.in_use);
                    const cstackStatus = formatCstackStatus(ws.cstack, ws);
                    const lastCommit = formatLastCommit(ws.git);
                    const sleeve = ws.sleeve_name || '-';
                    const actions = formatWorkspaceActions(ws);
                    return `
                    <tr>
                        <td>${ws.name}</td>
                        <td>${branch}</td>
                        <td>${gitStatus}</td>
                        <td>${cstackStatus}</td>
                        <td>${lastCommit}</td>
                        <td>${sleeve}</td>
                        <td>${actions}</td>
                    </tr>
                    `;
                }).join('');
            } catch (e) {
                console.error('Failed to fetch workspaces:', e);
            }
        }

        function formatGitBranch(git) {
            if (!git) return '<span class="git-no-repo">-</span>';
            const branchClass = git.is_detached ? 'git-detached' : 'git-branch';
            const prefix = git.is_detached ? 'detached@' : '';
            return `<span class="${branchClass}">${prefix}${git.branch}</span>`;
        }

        function formatGitStatus(git, inUse) {
            if (!git) return '-';
            const parts = [];

            if (git.is_dirty) {
                parts.push(`<span class="git-dirty">${git.uncommitted_count} uncommitted</span>`);
            } else {
                parts.push('<span class="git-clean">Clean</span>');
            }

            if (git.ahead_count > 0 || git.behind_count > 0) {
                const syncParts = [];
                if (git.ahead_count > 0) syncParts.push(`${git.ahead_count} ahead`);
                if (git.behind_count > 0) syncParts.push(`${git.behind_count} behind`);
                const syncClass = git.behind_count > 0 ? 'git-behind' : 'git-ahead';
                parts.push(`<span class="${syncClass}">${syncParts.join(', ')}</span>`);
            }

            return parts.join(' / ');
        }

        function formatLastCommit(git) {
            if (!git || !git.last_commit_hash) return '-';
            const msg = git.last_commit_msg.length > 30
                ? git.last_commit_msg.substring(0, 30) + '...'
                : git.last_commit_msg;
            return `<span class="git-commit-hash">${git.last_commit_hash}</span> ${msg} <span class="git-commit-time">(${git.last_commit_time})</span>`;
        }

        function formatWorkspaceActions(ws) {
            const isGitRepo = !!ws.git;
            const canSwitch = isGitRepo && !ws.in_use && !ws.git.is_dirty;
            const canPull = isGitRepo && !ws.in_use && !ws.git.is_dirty && ws.git.ahead_count === 0 && ws.git.behind_count > 0;
            const switchDisabled = !canSwitch ? 'disabled' : '';
            const fetchDisabled = !isGitRepo ? 'disabled' : '';
            const pullDisabled = !canPull ? 'disabled' : '';

            let switchTitle = 'Switch branch';
            if (!isGitRepo) {
                switchTitle = 'Not a git repository';
            } else if (ws.in_use) {
                switchTitle = 'Workspace in use by ' + ws.sleeve_name;
            } else if (ws.git.is_dirty) {
                switchTitle = 'Has uncommitted changes';
            }

            let pullTitle = 'Pull from remote';
            if (!isGitRepo) {
                pullTitle = 'Not a git repository';
            } else if (ws.in_use) {
                pullTitle = 'Workspace in use by ' + ws.sleeve_name;
            } else if (ws.git.is_dirty) {
                pullTitle = 'Has uncommitted changes';
            } else if (ws.git.ahead_count > 0) {
                pullTitle = 'Has local commits - push first';
            } else if (ws.git.behind_count === 0) {
                pullTitle = 'Already up to date';
            }

            const escapedPath = ws.path.replace(/'/g, "\\'");
            const escapedName = ws.name.replace(/'/g, "\\'");

            return `<div class="action-buttons">
                <button class="btn btn-secondary btn-small" ${switchDisabled} title="${switchTitle}"
                        onclick="showSwitchModal('${escapedPath}', '${escapedName}')">Switch</button>
                <button class="btn btn-secondary btn-small" ${fetchDisabled} title="${isGitRepo ? 'Fetch from remote' : 'Not a git repository'}"
                        onclick="fetchRemote('${escapedPath}', this)">Fetch</button>
                <button class="btn btn-secondary btn-small" ${pullDisabled} title="${pullTitle}"
                        onclick="pullRemote('${escapedPath}', this)">Pull</button>
            </div>`;
        }

        let initializingCstackPaths = new Set();

        function formatCstackStatus(cstack, ws) {
            if (initializingCstackPaths.has(ws.path)) {
                return `<span style="color:#8b949e"><span class="inline-spinner"></span> Initializing...</span>`;
            }

            if (!cstack || !cstack.exists) {
                const escapedPath = ws.path.replace(/'/g, "\\'");
                return `<button class="btn btn-secondary btn-small"
                        onclick="showCstackInitModal('${escapedPath}', '${ws.name}')">
                    Init Stack
                </button>`;
            }

            const parts = [];
            if (cstack.ready > 0) {
                parts.push(`<span style="color:#3fb950;font-weight:600">${cstack.ready} ready</span>`);
            }
            if (cstack.in_progress > 0) {
                parts.push(`<span style="color:#58a6ff">${cstack.in_progress} active</span>`);
            }
            if (cstack.blocked > 0) {
                parts.push(`<span style="color:#f85149">${cstack.blocked} blocked</span>`);
            }
            if (cstack.open > 0 && cstack.ready === 0 && cstack.in_progress === 0) {
                parts.push(`<span style="color:#d29922">${cstack.open} open</span>`);
            }

            if (parts.length === 0) {
                return `<span style="color:#8b949e">No tasks</span>`;
            }

            return parts.join(' / ');
        }

        let currentSwitchWsPath = '';

        async function showSwitchModal(wsPath, wsName) {
            currentSwitchWsPath = wsPath;
            document.getElementById('switch-ws-name').textContent = wsName;
            document.getElementById('switch-ws-path').value = wsPath;
            document.getElementById('switch-error').classList.add('hidden');
            document.getElementById('branch-select').innerHTML = '<option value="">Loading branches...</option>';
            document.getElementById('switch-branch-modal').classList.add('active');

            try {
                const resp = await fetch(`/api/workspaces/branches?workspace=${encodeURIComponent(wsPath)}`);
                if (!resp.ok) {
                    const err = await resp.text();
                    document.getElementById('switch-error').textContent = err;
                    document.getElementById('switch-error').classList.remove('hidden');
                    return;
                }

                const branches = await resp.json();
                const select = document.getElementById('branch-select');
                let options = '';

                if (branches.local && branches.local.length > 0) {
                    options += '<optgroup label="Local Branches">';
                    for (const b of branches.local) {
                        const selected = b === branches.current ? 'selected' : '';
                        const current = b === branches.current ? ' (current)' : '';
                        options += `<option value="${b}" ${selected}>${b}${current}</option>`;
                    }
                    options += '</optgroup>';
                }

                if (branches.remote && branches.remote.length > 0) {
                    options += '<optgroup label="Remote Branches">';
                    for (const b of branches.remote) {
                        options += `<option value="${b}">${b}</option>`;
                    }
                    options += '</optgroup>';
                }

                if (options === '') {
                    options = '<option value="">No branches found</option>';
                }

                select.innerHTML = options;
            } catch (e) {
                document.getElementById('switch-error').textContent = e.message;
                document.getElementById('switch-error').classList.remove('hidden');
            }
        }

        function hideSwitchModal() {
            document.getElementById('switch-branch-modal').classList.remove('active');
            document.getElementById('switch-form').reset();
            document.getElementById('switch-error').classList.add('hidden');
            hideSwitchLoading();
            currentSwitchWsPath = '';
        }

        function showSwitchLoading(msg) {
            document.querySelector('.switch-loading-text').textContent = msg || 'Switching branch...';
            document.getElementById('switch-loading').classList.add('active');
            document.getElementById('switch-submit-btn').disabled = true;
        }

        function hideSwitchLoading() {
            document.getElementById('switch-loading').classList.remove('active');
            document.getElementById('switch-submit-btn').disabled = false;
        }

        async function switchBranch(e) {
            e.preventDefault();
            const wsPath = document.getElementById('switch-ws-path').value;
            const branch = document.getElementById('branch-select').value;

            if (!branch) {
                document.getElementById('switch-error').textContent = 'Please select a branch';
                document.getElementById('switch-error').classList.remove('hidden');
                return;
            }

            showSwitchLoading('Switching to ' + branch + '...');
            document.getElementById('switch-error').classList.add('hidden');

            try {
                const resp = await fetch(`/api/workspaces/branches?workspace=${encodeURIComponent(wsPath)}&action=switch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ workspace: wsPath, branch: branch })
                });

                if (!resp.ok) {
                    const err = await resp.text();
                    document.getElementById('switch-error').textContent = err;
                    document.getElementById('switch-error').classList.remove('hidden');
                    hideSwitchLoading();
                    return;
                }

                hideSwitchLoading();
                hideSwitchModal();
                refreshWorkspacesTable();
            } catch (e) {
                hideSwitchLoading();
                document.getElementById('switch-error').textContent = e.message;
                document.getElementById('switch-error').classList.remove('hidden');
            }
        }

        async function fetchRemote(wsPath, btn) {
            const originalText = btn.textContent;
            btn.textContent = 'Fetching...';
            btn.disabled = true;

            try {
                const resp = await fetch(`/api/workspaces/branches?workspace=${encodeURIComponent(wsPath)}&action=fetch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ workspace: wsPath })
                });

                if (!resp.ok) {
                    const err = await resp.text();
                    alert('Fetch failed: ' + err);
                    btn.textContent = originalText;
                    btn.disabled = false;
                    return;
                }

                btn.textContent = 'Done!';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                    refreshWorkspacesTable();
                }, 1000);
            } catch (e) {
                alert('Fetch failed: ' + e.message);
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        async function pullRemote(wsPath, btn) {
            const originalText = btn.textContent;
            btn.textContent = 'Pulling...';
            btn.disabled = true;

            try {
                const resp = await fetch(`/api/workspaces/branches?workspace=${encodeURIComponent(wsPath)}&action=pull`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ workspace: wsPath })
                });

                if (!resp.ok) {
                    const err = await resp.text();
                    alert('Pull failed: ' + err);
                    btn.textContent = originalText;
                    btn.disabled = false;
                    return;
                }

                const result = await resp.json();
                if (!result.success) {
                    alert('Pull failed: ' + (result.message || 'unknown error'));
                    btn.textContent = originalText;
                    btn.disabled = false;
                    return;
                }

                btn.textContent = 'Done!';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                    refreshWorkspacesTable();
                }, 1000);
            } catch (e) {
                alert('Pull failed: ' + e.message);
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function showCstackInitModal(wsPath, wsName) {
            document.getElementById('cstack-init-ws-name').textContent = wsName;
            document.getElementById('cstack-init-ws-path').value = wsPath;
            document.getElementById('cstack-init-error').classList.add('hidden');
            document.getElementById('cstack-init-modal').classList.add('active');
        }

        function hideCstackInitModal() {
            document.getElementById('cstack-init-modal').classList.remove('active');
            document.getElementById('cstack-init-form').reset();
            document.getElementById('cstack-init-error').classList.add('hidden');
        }

        async function initCstack(e) {
            e.preventDefault();
            const wsPath = document.getElementById('cstack-init-ws-path').value;
            const mode = document.querySelector('input[name="cstack-mode"]:checked').value;

            // Close modal immediately and show spinner in table
            hideCstackInitModal();
            initializingCstackPaths.add(wsPath);
            await refreshWorkspacesTable();

            try {
                const resp = await fetch(
                    `/api/workspaces/cstack?workspace=${encodeURIComponent(wsPath)}&action=init`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ mode: mode })
                    }
                );

                const result = await resp.json();
                initializingCstackPaths.delete(wsPath);

                // "already initialized" is fine - cstack exists, just refresh
                if (!result.success && result.error && !result.error.includes('already')) {
                    alert('Cstack init failed: ' + result.error);
                }

                await refreshWorkspacesTable();

            } catch (err) {
                initializingCstackPaths.delete(wsPath);
                alert('Cstack init failed: ' + err.message);
                await refreshWorkspacesTable();
            }
        }

        function updateWorkspaceSelect() {
            const select = document.getElementById('existing-workspace-select');
            const available = workspacesCache.filter(ws => !ws.in_use);
            if (available.length === 0) {
                select.innerHTML = '<option value="">No available workspaces</option>';
                return;
            }
            select.innerHTML = available.map(ws =>
                `<option value="${ws.path}">${ws.name}</option>`
            ).join('');
        }

        function toggleWorkspaceMode() {
            const mode = document.querySelector('input[name="ws-mode"]:checked').value;
            const newGroup = document.getElementById('new-ws-group');
            const existingGroup = document.getElementById('existing-ws-group');
            const newInput = document.getElementById('new-workspace-input');
            const existingSelect = document.getElementById('existing-workspace-select');

            newGroup.classList.add('hidden');
            existingGroup.classList.add('hidden');
            newInput.required = false;
            existingSelect.required = false;

            if (mode === 'new') {
                newGroup.classList.remove('hidden');
                newInput.required = true;
            } else if (mode === 'existing') {
                existingGroup.classList.remove('hidden');
                existingSelect.required = true;
            }
        }

        async function showSpawnModal() {
            await refreshWorkspaces();
            toggleWorkspaceMode();
            document.getElementById('spawn-modal').classList.add('active');
        }

        function hideSpawnModal() {
            document.getElementById('spawn-modal').classList.remove('active');
            document.getElementById('spawn-form').reset();
            hideSpawnLoading();
            toggleWorkspaceMode();
        }

        function showSpawnLoading(msg) {
            document.querySelector('.spawn-loading-text').textContent = msg || 'Spawning sleeve...';
            document.getElementById('spawn-loading').classList.add('active');
        }

        function hideSpawnLoading() {
            document.getElementById('spawn-loading').classList.remove('active');
        }

        function showCloneModal() {
            document.getElementById('clone-modal').classList.add('active');
            document.getElementById('clone-error').classList.add('hidden');
        }

        function hideCloneModal() {
            document.getElementById('clone-modal').classList.remove('active');
            document.getElementById('clone-form').reset();
            document.getElementById('clone-error').classList.add('hidden');
            hideCloneLoading();
            stopClonePolling();
        }

        function showCloneLoading(msg) {
            document.querySelector('.clone-loading-text').textContent = msg || 'Cloning repository...';
            document.getElementById('clone-loading').classList.add('active');
            document.getElementById('clone-submit-btn').disabled = true;
        }

        function hideCloneLoading() {
            document.getElementById('clone-loading').classList.remove('active');
            document.getElementById('clone-submit-btn').disabled = false;
        }

        function stopClonePolling() {
            if (clonePollingInterval) {
                clearInterval(clonePollingInterval);
                clonePollingInterval = null;
            }
            currentCloneJobId = null;
        }

        async function cloneWorkspace(e) {
            e.preventDefault();
            const repoUrl = document.getElementById('clone-url-input').value;
            const name = document.getElementById('clone-name-input').value;

            if (!repoUrl) {
                alert('Please enter a repository URL');
                return;
            }

            showCloneLoading('Starting clone...');
            document.getElementById('clone-error').classList.add('hidden');

            try {
                const resp = await fetch('/api/workspaces/clone', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ repo_url: repoUrl, name: name || undefined })
                });

                if (!resp.ok) {
                    const err = await resp.text();
                    document.getElementById('clone-error').textContent = err;
                    document.getElementById('clone-error').classList.remove('hidden');
                    hideCloneLoading();
                    return;
                }

                const job = await resp.json();
                currentCloneJobId = job.id;
                showCloneLoading('Cloning repository...');

                clonePollingInterval = setInterval(async () => {
                    try {
                        const statusResp = await fetch(`/api/workspaces/clone?id=${currentCloneJobId}`);
                        const jobStatus = await statusResp.json();

                        if (jobStatus.status === 'completed') {
                            stopClonePolling();
                            hideCloneLoading();
                            hideCloneModal();
                            refreshWorkspacesTable();
                            refreshWorkspaces();
                        } else if (jobStatus.status === 'failed') {
                            stopClonePolling();
                            hideCloneLoading();
                            document.getElementById('clone-error').textContent = jobStatus.error || 'Clone failed';
                            document.getElementById('clone-error').classList.remove('hidden');
                        }
                    } catch (pollErr) {
                        console.error('Failed to poll clone status:', pollErr);
                    }
                }, 1000);

            } catch (e) {
                hideCloneLoading();
                document.getElementById('clone-error').textContent = e.message;
                document.getElementById('clone-error').classList.remove('hidden');
            }
        }

        async function spawnSleeve(e) {
            e.preventDefault();
            const mode = document.querySelector('input[name="ws-mode"]:checked').value;
            const name = document.getElementById('name-input').value;
            let workspace;

            try {
                if (mode === 'new') {
                    const wsName = document.getElementById('new-workspace-input').value;
                    if (!wsName) {
                        alert('Please enter a workspace name');
                        return;
                    }
                    showSpawnLoading('Creating workspace...');
                    const createResp = await fetch('/api/workspaces', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: wsName })
                    });
                    if (!createResp.ok) {
                        hideSpawnLoading();
                        const err = await createResp.text();
                        alert('Failed to create workspace: ' + err);
                        return;
                    }
                    const wsData = await createResp.json();
                    workspace = wsData.path;
                } else if (mode === 'existing') {
                    workspace = document.getElementById('existing-workspace-select').value;
                    if (!workspace) {
                        alert('Please select a workspace');
                        return;
                    }
                }

                showSpawnLoading('Spawning sleeve...');
                const body = { workspace, name: name || undefined };
                const resp = await fetch('/api/sleeves', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!resp.ok) {
                    hideSpawnLoading();
                    const err = await resp.text();
                    alert('Failed to spawn sleeve: ' + err);
                    return;
                }

                hideSpawnLoading();
                hideSpawnModal();
                refreshSleeves();
                refreshContainers();
            } catch (e) {
                hideSpawnLoading();
                console.error('Failed to spawn sleeve:', e);
                alert('Failed to spawn sleeve: ' + e.message);
            }
        }

        async function killSleeve(name) {
            if (!confirm(`Are you sure you want to kill sleeve "${name}"?`)) {
                return;
            }

            try {
                const resp = await fetch(`/api/sleeves/${name}`, { method: 'DELETE' });
                if (!resp.ok) {
                    const err = await resp.text();
                    alert('Failed to kill sleeve: ' + err);
                    return;
                }
                refreshSleeves();
                refreshContainers();
            } catch (e) {
                console.error('Failed to kill sleeve:', e);
            }
        }

        function openTerminalWithPath(title, wsPath) {
            document.getElementById('terminal-title').textContent = title;
            document.getElementById('terminal-modal').classList.add('active');
            document.getElementById('reconnect-info').textContent = '';

            const container = document.getElementById('terminal-container');

            if (currentConnection) {
                currentConnection.dispose();
            }

            currentConnection = new TerminalConnection(container, wsPath, title);
            currentConnection.connect();
        }

        function openTerminal(name) {
            openTerminalWithPath(`Terminal - ${name}`, `/sleeves/${name}/terminal`);
        }

        function openEnvoyTerminal() {
            openTerminalWithPath('Terminal - Envoy (Poe)', '/envoy/terminal');
        }

        function hideTerminalModal() {
            document.getElementById('terminal-modal').classList.remove('active');
            if (currentConnection) {
                currentConnection.dispose();
                currentConnection = null;
            }
        }

        checkAuth();
        refreshContainers();
        refreshNetworks();
        refreshSleeves();

        setInterval(() => {
            refreshSleeves();
            refreshContainers();
        }, 5000);
    </script>
</body>
</html>
