<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protectorate // Envoy</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Orbitron:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css">
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="scanlines"></div>

    <nav class="top-nav">
        <div class="brand">PROTECTORATE <span>//ENVOY</span></div>
        <div class="nav-right">
            <button class="btn" onclick="openEnvoyTerminal()">Terminal</button>
            <span class="cluster-badge">cluster: local</span>
        </div>
    </nav>

    <nav class="tab-nav">
        <div class="tab active" onclick="switchTab('sleeves')">Sleeves</div>
        <div class="tab" onclick="switchTab('needlecast')">Needlecast</div>
        <div class="tab" onclick="switchTab('logs')">Logs</div>
        <div class="tab" onclick="switchTab('config')">Config</div>
        <div class="tab" onclick="switchTab('workspaces')">Workspaces</div>
        <div class="tab" onclick="switchTab('doctor')">Doctor</div>
    </nav>

    <!-- SLEEVES TAB -->
    <div id="tab-sleeves" class="tab-content active">
        <main class="main-content">
            <div class="dashboard-header">
                <h1 class="dashboard-title">SLEEVE REGISTRY</h1>
                <div class="dashboard-stats">
                    <div class="stat">
                        <div id="stat-active" class="stat-value">0</div>
                        <div class="stat-label">Active</div>
                    </div>
                    <button class="btn btn-primary" onclick="showSpawnModal()">+ SPAWN SLEEVE</button>
                </div>
            </div>

            <!-- Host Resources -->
            <div class="host-resources">
                <div class="host-resources-header">
                    <span class="host-resources-title">Host Resources</span>
                </div>
                <div class="host-resources-grid">
                    <div class="host-resource">
                        <div class="host-resource-header">
                            <span class="host-resource-label">CPU</span>
                            <span id="host-cpu-value" class="host-resource-value">--%</span>
                        </div>
                        <div class="host-resource-bar">
                            <div id="host-cpu-bar" class="host-resource-fill" style="width: 0%"></div>
                        </div>
                        <span id="host-cpu-detail" class="host-resource-detail">-- cores / -- threads</span>
                    </div>
                    <div class="host-resource">
                        <div class="host-resource-header">
                            <span class="host-resource-label">Memory</span>
                            <span id="host-memory-value" class="host-resource-value">-- GB</span>
                        </div>
                        <div class="host-resource-bar">
                            <div id="host-memory-bar" class="host-resource-fill" style="width: 0%"></div>
                        </div>
                        <span id="host-memory-detail" class="host-resource-detail">-- / -- GB used</span>
                    </div>
                    <div class="host-resource">
                        <div class="host-resource-header">
                            <span class="host-resource-label">Disk</span>
                            <span id="host-disk-value" class="host-resource-value">-- GB</span>
                        </div>
                        <div class="host-resource-bar">
                            <div id="host-disk-bar" class="host-resource-fill" style="width: 0%"></div>
                        </div>
                        <span id="host-disk-detail" class="host-resource-detail">-- / -- GB used</span>
                    </div>
                    <div class="host-resource">
                        <div class="host-resource-header">
                            <span class="host-resource-label">Docker</span>
                            <span id="host-docker-value" class="host-resource-value">--</span>
                        </div>
                        <div class="host-resource-bar">
                            <div id="host-docker-bar" class="host-resource-fill" style="width: 0%"></div>
                        </div>
                        <span id="host-docker-detail" class="host-resource-detail">-- containers / -- limit</span>
                    </div>
                </div>
            </div>

            <div id="sleeves-grid" class="sleeve-grid">
                <div class="empty-state">No sleeves running. Click "+ SPAWN SLEEVE" to create one.</div>
            </div>
        </main>
    </div>

    <!-- NEEDLECAST TAB -->
    <div id="tab-needlecast" class="tab-content">
        <main class="main-content">
            <div class="dashboard-header">
                <h1 class="dashboard-title">NEEDLECAST</h1>
            </div>
            <div class="needlecast-layout">
                <div class="needlecast-sidebar">
                    <div class="needlecast-sidebar-title">Sleeves</div>
                    <div class="needlecast-sleeve-item active">GLOBAL</div>
                    <div id="needlecast-sleeve-list"></div>
                </div>
                <div class="needlecast-main">
                    <div class="needlecast-messages">
                        <div class="placeholder-content">
                            <div class="placeholder-title">Inter-Sleeve Messaging</div>
                            <div class="placeholder-desc">Select a sleeve to view messages. Needlecast enables real-time communication between sleeves via filesystem-based messaging.</div>
                        </div>
                    </div>
                    <div class="needlecast-input">
                        <input type="text" placeholder="Message content..." disabled>
                        <button class="btn" disabled>Send</button>
                    </div>
                </div>
                <div class="needlecast-thread">
                    <div class="needlecast-thread-title">Thread Visualization</div>
                    <div class="placeholder-content" style="min-height: 200px;">
                        <div class="placeholder-desc">Message flow visualization coming soon</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- LOGS TAB -->
    <div id="tab-logs" class="tab-content">
        <main class="main-content">
            <div class="dashboard-header">
                <h1 class="dashboard-title">LOGS</h1>
            </div>
            <div class="panel">
                <div class="panel-body">
                    <div class="placeholder-content">
                        <div class="placeholder-title">System Logs</div>
                        <div class="placeholder-desc">Aggregated logs from Envoy and all active sleeves. Coming soon.</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- CONFIG TAB -->
    <div id="tab-config" class="tab-content">
        <main class="main-content">
            <div class="dashboard-header">
                <h1 class="dashboard-title">CONFIGURATION</h1>
            </div>
            <div class="panel">
                <div class="panel-body">
                    <div class="placeholder-content">
                        <div class="placeholder-title">System Configuration</div>
                        <div class="placeholder-desc">Envoy and sleeve configuration management. Coming soon.</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- WORKSPACES TAB -->
    <div id="tab-workspaces" class="tab-content">
        <main class="main-content">
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">WORKSPACES</span>
                    <div style="display: flex; align-items: center;">
                        <span id="fetch-indicator" class="fetch-indicator" style="display: none;">fetching...</span>
                        <button class="btn btn-primary" onclick="showCloneModal()">+ Clone from Git</button>
                    </div>
                </div>
                <div class="panel-body">
                    <table id="workspaces-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Branch</th>
                                <th>Git Status</th>
                                <th>Cstack</th>
                                <th>Last Commit</th>
                                <th>Sleeve</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <div id="workspaces-empty" class="empty-state hidden">
                        No workspaces yet. Click "+ Clone from Git" to clone a repository.
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- DOCTOR TAB -->
    <div id="tab-doctor" class="tab-content">
        <main class="main-content">
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">SYSTEM HEALTH CHECKS</span>
                    <button class="btn" onclick="refreshDoctor()">Refresh</button>
                </div>
                <div class="panel-body">
                    <div id="doctor-checks" class="doctor-checks">
                        <div class="empty-state">Loading checks...</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- SPAWN MODAL -->
    <div id="spawn-modal" class="modal">
        <div class="modal-content">
            <div id="spawn-loading" class="spawn-loading">
                <div class="spinner"></div>
                <div class="spawn-loading-text">Spawning sleeve...</div>
            </div>
            <h2 class="modal-title">SPAWN NEW SLEEVE</h2>
            <form id="spawn-form" onsubmit="spawnSleeve(event)">
                <div class="form-group">
                    <label class="form-label">Workspace</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="ws-mode" value="existing" checked onchange="toggleWorkspaceMode()">
                            Use existing
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="ws-mode" value="new" onchange="toggleWorkspaceMode()">
                            Create new
                        </label>
                    </div>
                </div>
                <div class="form-group" id="existing-ws-group">
                    <label class="form-label">Select Workspace</label>
                    <select class="form-select" id="existing-workspace-select" required>
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="form-group hidden" id="new-ws-group">
                    <label class="form-label">Workspace Name</label>
                    <input type="text" class="form-input" id="new-workspace-input"
                           placeholder="my-project" pattern="[a-zA-Z0-9_\-]+"
                           title="Letters, numbers, dashes, underscores only">
                </div>
                <div class="form-group">
                    <label class="form-label">Sleeve Name (optional)</label>
                    <input type="text" class="form-input" id="name-input"
                           placeholder="Auto-assigned from pool">
                </div>
                <div class="form-group">
                    <label class="radio-option">
                        <input type="checkbox" id="advanced-toggle" onchange="toggleAdvancedOptions()">
                        Advanced Options (Resource Constraints)
                    </label>
                </div>
                <div id="advanced-options" class="hidden">
                    <div class="form-group">
                        <label class="form-label">Memory Limit</label>
                        <select class="form-select" id="memory-limit-select">
                            <option value="0">Unlimited</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">CPU Limit</label>
                        <select class="form-select" id="cpu-limit-select">
                            <option value="0">Unlimited</option>
                        </select>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="hideSpawnModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Spawn</button>
                </div>
            </form>
        </div>
    </div>

    <!-- CLONE MODAL -->
    <div id="clone-modal" class="modal">
        <div class="modal-content">
            <div id="clone-loading" class="spawn-loading">
                <div class="spinner"></div>
                <div class="clone-loading-text">Cloning repository...</div>
            </div>
            <h2 class="modal-title">CLONE REPOSITORY</h2>
            <form id="clone-form" onsubmit="cloneWorkspace(event)">
                <div class="form-group">
                    <label class="form-label">Repository URL</label>
                    <input type="url" class="form-input" id="clone-url-input"
                           placeholder="https://github.com/owner/repo"
                           pattern="https://.*"
                           title="HTTPS URLs only"
                           required>
                </div>
                <div class="form-group">
                    <label class="form-label">Workspace Name (optional)</label>
                    <input type="text" class="form-input" id="clone-name-input"
                           placeholder="Auto-derived from repo URL"
                           pattern="[a-zA-Z0-9_\-]*"
                           title="Letters, numbers, dashes, underscores only">
                </div>
                <div id="clone-error" class="error-text hidden"></div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="hideCloneModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="clone-submit-btn">Clone</button>
                </div>
            </form>
        </div>
    </div>

    <!-- SWITCH BRANCH MODAL -->
    <div id="switch-branch-modal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">SWITCH BRANCH</h2>
            <p style="margin-bottom: 1rem; color: var(--text-secondary);">Workspace: <strong id="switch-ws-name" style="color: var(--cyan-glow);"></strong></p>
            <form id="switch-form" onsubmit="switchBranch(event)">
                <div class="form-group">
                    <label class="form-label">Select Branch</label>
                    <select class="form-select" id="branch-select" required>
                        <option value="">Loading branches...</option>
                    </select>
                </div>
                <div id="switch-error" class="error-text hidden"></div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="hideSwitchModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="switch-submit-btn">Switch</button>
                </div>
            </form>
            <input type="hidden" id="switch-ws-path">
        </div>
    </div>

    <!-- CSTACK INIT MODAL -->
    <div id="cstack-init-modal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">INITIALIZE CSTACK</h2>
            <p style="color: var(--text-secondary);">Workspace: <strong id="cstack-init-ws-name" style="color: var(--cyan-glow);"></strong></p>

            <form id="cstack-init-form" onsubmit="initCstack(event)">
                <div class="form-group">
                    <label class="form-label">Choose initialization mode:</label>

                    <div style="margin:0.75rem 0;padding:0.75rem;background:var(--bg-deep);border:1px solid var(--cyan-subtle);border-radius:6px">
                        <label style="display:flex;align-items:start;cursor:pointer">
                            <input type="radio" name="cstack-mode" value="minimal" checked style="margin-top:4px">
                            <div style="margin-left:0.5rem">
                                <strong style="color:var(--text-primary)">Minimal</strong>
                                <div style="color:var(--text-secondary);font-size:var(--text-sm)">Create empty .cstack/ directory</div>
                            </div>
                        </label>
                    </div>

                    <div style="margin:0.75rem 0;padding:0.75rem;background:var(--bg-deep);border:1px solid var(--cyan-subtle);border-radius:6px">
                        <label style="display:flex;align-items:start;cursor:pointer">
                            <input type="radio" name="cstack-mode" value="interview" style="margin-top:4px">
                            <div style="margin-left:0.5rem">
                                <strong style="color:var(--text-primary)">Interview (Recommended)</strong>
                                <div style="color:var(--text-secondary);font-size:var(--text-sm)">Init + mark for Claude interview on sleeve spawn</div>
                            </div>
                        </label>
                    </div>
                </div>

                <div id="cstack-init-error" class="error-text hidden"></div>

                <div class="form-actions">
                    <button type="button" class="btn" onclick="hideCstackInitModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="cstack-init-btn">Initialize</button>
                </div>
            </form>
            <input type="hidden" id="cstack-init-ws-path">
        </div>
    </div>

    <!-- TERMINAL MODAL -->
    <div id="terminal-modal" class="modal">
        <div class="modal-content terminal-modal">
            <div class="terminal-header">
                <div style="display: flex; align-items: center;">
                    <span id="terminal-title" style="color: var(--cyan-glow);">Terminal</span>
                    <span id="terminal-readonly-badge" class="terminal-readonly-badge">Read-Only</span>
                    <span id="terminal-status" class="terminal-status"></span>
                    <span id="reconnect-info" class="reconnect-info"></span>
                </div>
                <button class="btn" onclick="hideTerminalModal()">Close</button>
            </div>
            <div id="terminal-container" class="terminal-container"></div>
        </div>
    </div>

    <div id="notify-container" class="notify-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.min.js"></script>
    <script src="/static/app.js"></script>
</body>
</html>
